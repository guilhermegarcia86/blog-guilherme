<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Blog · Tutoriais</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Um website pra divulgar conhecimento"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Blog · Tutoriais"/><meta property="og:type" content="website"/><meta property="og:url" content="https://guilhermegarcia86.github.io/blog-guilherme/"/><meta property="og:description" content="Um website pra divulgar conhecimento"/><meta property="og:image" content="https://guilhermegarcia86.github.io/blog-guilherme/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://guilhermegarcia86.github.io/blog-guilherme/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/blog-guilherme/img/dog.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://guilhermegarcia86.github.io/blog-guilherme/blog/atom.xml" title="Tutoriais Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://guilhermegarcia86.github.io/blog-guilherme/blog/feed.xml" title="Tutoriais Blog RSS Feed"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/blog-guilherme/js/scrollSpy.js"></script><link rel="stylesheet" href="/blog-guilherme/css/main.css"/><script src="/blog-guilherme/js/codetabs.js"></script></head><body class="blog"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/blog-guilherme/"><img class="logo" src="/blog-guilherme/img/dog.png" alt="Tutoriais"/><h2 class="headerTitleWithLogo">Tutoriais</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/blog-guilherme/docs/doc4" target="_self">Apostilas</a></li><li class="siteNavGroupActive siteNavItemActive"><a href="/blog-guilherme/blog/" target="_self">Blog</a></li><li class=""><a href="about" target="_self">About</a></li><li class=""><a target="_self"></a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Recent Posts</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Recent Posts</h3><ul class=""><li class="navListItem"><a class="navItem" href="/blog-guilherme/blog/2020/04/25/post-spring-mongo">Spring Mongo</a></li><li class="navListItem"><a class="navItem" href="/blog-guilherme/blog/2020/04/24/post-s3">AWS S3</a></li><li class="navListItem"><a class="navItem" href="/blog-guilherme/blog/2020/04/24/post-ecs">AWS ECS</a></li><li class="navListItem"><a class="navItem" href="/blog-guilherme/blog/2020/04/20/post-kubernetes">Kubernetes</a></li><li class="navListItem"><a class="navItem" href="/blog-guilherme/blog/2020/04/10/post-docker">Docker</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer postContainer blogContainer"><div class="wrapper"><div class="posts"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle"><a href="/blog-guilherme/blog/2020/04/25/post-spring-mongo">Spring Mongo</a></h1><p class="post-meta">April 25, 2020</p><div class="authorBlock"><p class="post-authorName"><a href="https://twitter.com/guilherme_ga86" target="_blank" rel="noreferrer noopener">Guilherme Alves</a></p><div class="authorPhoto"><a href="https://twitter.com/guilherme_ga86" target="_blank" rel="noreferrer noopener"><img src="https://graph.facebook.com/1426803577/picture/?height=200&amp;width=200" alt="Guilherme Alves"/></a></div></div></header><article class="post-content"><div><span><h1><a class="anchor" aria-hidden="true" id="criando-uma-aplicação-spring-boot-com-mongodb-e-geolocalização"></a><a href="#criando-uma-aplicação-spring-boot-com-mongodb-e-geolocalização" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Criando uma aplicação Spring Boot com MongoDB e geolocalização</h1>
<p>O objetivo desse post é criar uma aplicação de geolocalização, dizer quais pontos estão próximos de você por exemplo isso é muito útil se você uma empresa de entregas e precisa saber qual fornecedor está mais próximo para a entrega e várias aplicações do gênero. Para isso usarei aqui Spring Boot, pois tem toda uma facilidade para criação do projeto e uma comunidade e documentações muito ativas, MongoDB além de ser uma boa opção por toda a flexibilidade que ele trás também é muito útil nesse cenário onde vamos precisar fazer cálculos de geolocalização e ele nativamente possui isso.
Aqui faremos só o backend da aplicação e futuramente desenvolveremos o frontend.</p>
<h2><a class="anchor" aria-hidden="true" id="criando-a-aplicação-spring-boot"></a><a href="#criando-a-aplicação-spring-boot" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Criando a aplicação Spring Boot</h2>
<p>Para isso vamos usar o <a href="https://start.spring.io/">Spring Initalizr</a>, entrando na página escolhemos como queremos iniciar o projeto, aqui eu irei usar o <em>Spring Web</em> para poder fazer requisições <em>Rest</em>, também estou usando <em>Lombok</em> e <em>Spring DevTools</em> mas são mais pela facilidade que o <em>Lombok</em> fornece quando criarmos os nossos <strong>POJOs</strong> e o <em>DevTools</em> para podermos usar em desenvolvimento e termos o live reload da aplicação.
Então fica mais ou menos assim o projeto:
<img src="/blog-guilherme/blog/assets/spring-initializr.png" alt=""></p>
<p>Após isso também precisamos adicionar ao projeto a dependência do <strong>google-service-maps</strong>, como estou usando <em>Maven</em></p>
<pre><code class="hljs css language-xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.google.maps/google-maps-services --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.maps<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>google-maps-services<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

</code></pre>
<p>Também adicione o driver do Mongo ao pom.</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mongo-java-driver<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="descrição-da-aplicação"></a><a href="#descrição-da-aplicação" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Descrição da aplicação</h2>
<p>Vamos emular uma rede entregas de alimentos, onde os estabelecimentos estão cadastrados e quando um usuário digitar o seu endereço e ele irá exibir os mais próximos dele.</p>
<h2><a class="anchor" aria-hidden="true" id="model"></a><a href="#model" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Model</h2>
<p>Vamos começar o nosso model com o que seria então o <strong>Estabelecimento</strong> ele possuirá <em>nome</em>, <em>email</em> e a sua <em>localização</em>. Então vou começar criando a classe <strong>Localizacao</strong>.</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">package</span> com.challenge.geolocation.model;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Localizacao</span> </span>{
    
    <span class="hljs-keyword">private</span> String endereco;
    <span class="hljs-keyword">private</span> List&lt;Double&gt; coordinates;    
    <span class="hljs-keyword">private</span> String type = <span class="hljs-string">"Point"</span>;

}
</code></pre>
<p>Aqui temos o endereço mas também temos dois atributos que podem parecer um pouco estranhos o <em>coordinates</em> e o <em>type</em>. Os dois são necessários quando estamos trabalhando com geolocalização com o Mongo, o primeiro valor <em>coordinates</em> é uma lista de <strong>double</strong> contendo a latitude e longitude e o <em>type</em> diz respeito a um ponto no mapa, podemos ter outros <em>types</em> como <strong>Polygon</strong>.
Agora criando a nossa classe do estabelecimento propriamente dita.</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">package</span> com.challenge.geolocation.model;

<span class="hljs-keyword">import</span> org.springframework.data.annotation.Id;
<span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.geo.GeoJsonPoint;
<span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;

<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-keyword">package</span> com.challenge.geolocation.model;
<span class="hljs-keyword">import</span> org.

<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-meta">@Datapublic</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Estabelecimento</span>

    <span class="hljs-title">private</span> <span class="hljs-title">ObjectId</span> <span class="hljs-title">id</span></span>;

    <span class="hljs-keyword">private</span> String nome;
    <span class="hljs-keyword">private</span> String email;
    <span class="hljs-keyword">private</span> Localizacao localizacao;    
    
}

</code></pre>
<p>Temos aqui a classe <strong>Estabelecimento</strong> composta pela classe <strong>Localizacao</strong> e com os atributos <em>id</em> <em>lombok</em> nos ajuda a reduzir um pouco a verbozidade.</p>
<h2><a class="anchor" aria-hidden="true" id="codecs"></a><a href="#codecs" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Codecs</h2>
<p>Agora temos o <em>Model</em> criado mas precisamos fazer de alguma forma pra que a nossa aplicação se comunique com o <em>Mongo</em>. Aí entra os <em>codecs</em>, ele vai ser o responsável por fazer tanto o envio como o recebimento dos objetos do <em>Mongo</em>.
Então vamos criar a classe <strong>EstabelecimentoCodec</strong> que implementa a interface <strong>CollectibleCodec</strong> do tipo <strong>Estabelecimento</strong>:</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">package</span> com.challenge.geolocation.codec;

<span class="hljs-keyword">import</span> org.bson.BsonReader;
<span class="hljs-keyword">import</span> org.bson.BsonValue;
<span class="hljs-keyword">import</span> org.bson.BsonWriter;
<span class="hljs-keyword">import</span> org.bson.codecs.CollectibleCodec;
<span class="hljs-keyword">import</span> org.bson.codecs.DecoderContext;
<span class="hljs-keyword">import</span> org.bson.codecs.EncoderContext;

<span class="hljs-keyword">import</span> com.challenge.geolocation.model.Estabelecimento;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EstabelecimentoCodec</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CollectibleCodec</span>&lt;<span class="hljs-title">Estabelecimento</span>&gt;</span>{

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">encode</span><span class="hljs-params">(BsonWriter writer, Estabelecimento value, EncoderContext encoderContext)</span> </span>{
        <span class="hljs-comment">// TODO Auto-generated method stub</span>
        
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Class&lt;Estabelecimento&gt; <span class="hljs-title">getEncoderClass</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// TODO Auto-generated method stub</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Estabelecimento <span class="hljs-title">decode</span><span class="hljs-params">(BsonReader reader, DecoderContext decoderContext)</span> </span>{
        <span class="hljs-comment">// TODO Auto-generated method stub</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Estabelecimento <span class="hljs-title">generateIdIfAbsentFromDocument</span><span class="hljs-params">(Estabelecimento document)</span> </span>{
        <span class="hljs-comment">// TODO Auto-generated method stub</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">documentHasId</span><span class="hljs-params">(Estabelecimento document)</span> </span>{
        <span class="hljs-comment">// TODO Auto-generated method stub</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> BsonValue <span class="hljs-title">getDocumentId</span><span class="hljs-params">(Estabelecimento document)</span> </span>{
        <span class="hljs-comment">// TODO Auto-generated method stub</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }

}
</code></pre>
<p>Agora precisamos começar a implementar o codec a nossa maneira para ele poder fazer o encod e o decode, para isso vamos adicionar a classe <strong>Codec</strong> do pacote <em>bson</em> que nos ajuda, vamos tipa-la como um <strong>Document</strong> e vamos adicioná-lo ao construtor para ele ficar como dependência do nosso <em>codec</em>:</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">import</span> org.bson.Document;
<span class="hljs-keyword">import</span> org.bson.codecs.Codec;

<span class="hljs-keyword">import</span> com.challenge.geolocation.model.Estabelecimento;


<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EstabelecimentoCodec</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CollectibleCodec</span>&lt;<span class="hljs-title">Estabelecimento</span>&gt;</span>{
    
    <span class="hljs-keyword">private</span> Codec&lt;Document&gt; codec;
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EstabelecimentoCodec</span><span class="hljs-params">(Codec&lt;Document&gt; codec)</span> </span>{
        <span class="hljs-keyword">this</span>.codec = codec;
    }
</code></pre>
<p>Agora vamos implementar o método responsável por fazer o encode. Aqui é onde dizemos como serão salvo os nossos objetos em Java para um objeto do Mongo:</p>
<pre><code class="hljs css language-java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">encode</span><span class="hljs-params">(BsonWriter writer, Estabelecimento estabelecimento, EncoderContext encoder)</span> </span>{
    Document document = <span class="hljs-keyword">new</span> Document();
    
    document.put(<span class="hljs-string">"_id"</span>, estabelecimento.getId());
    document.put(<span class="hljs-string">"nome"</span>, estabelecimento.getNome());
    document.put(<span class="hljs-string">"email"</span>, estabelecimento.getEmail());
    
    Localizacao localizacao = estabelecimento.getLocalizacao();
    
    List&lt;Double&gt; coordinates = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    localizacao.getCoordinates().forEach(coordinates::add);
    
    document.put(<span class="hljs-string">"localizacao"</span>, <span class="hljs-keyword">new</span> Document()
            .append(<span class="hljs-string">"endereco"</span>, localizacao.getEndereco())
            .append(<span class="hljs-string">"coordinates"</span>, coordinates)
            .append(<span class="hljs-string">"type"</span>, localizacao.getType()));
    
    codec.encode(writer, document, encoder);
}
</code></pre>
<p>E aqui é onde impletamos o decode, como o Java vai interpretar o objeto retornado do Mongo:</p>
<pre><code class="hljs css language-java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Estabelecimento <span class="hljs-title">decode</span><span class="hljs-params">(BsonReader reader, DecoderContext decoderContext)</span> </span>{
    
    Document document = codec.decode(reader, decoderContext);
    
    Estabelecimento estabelecimento = <span class="hljs-keyword">new</span> Estabelecimento();
estabelecimento.
    estabelecimento.setNome(document.getString(<span class="hljs-string">"nome"</span>));
    estabelecimento.setEmail(document.getString(<span class="hljs-string">"email"</span>));
    
    Document localizacao = (Document) document.get(<span class="hljs-string">"localizacao"</span>);
    <span class="hljs-keyword">if</span>(localizacao != <span class="hljs-keyword">null</span>) {
        String endereco = localizacao.getString(<span class="hljs-string">"endereco"</span>);
        <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)
        List&lt;Double&gt; coordinates = (List&lt;Double&gt;) localizacao.get(<span class="hljs-string">"coordinates"</span>);
        
        Localizacao localizacaoEntity = <span class="hljs-keyword">new</span> Localizacao();
        localizacaoEntity.setEndereco(endereco);
        localizacaoEntity.setCoordinates(coordinates);
        
        estabelecimento.setLocalizacao(localizacaoEntity);
    }
    
    <span class="hljs-keyword">return</span> estabelecimento;
}
</code></pre>
<p>E temos os outros métodos que implementamos para que o codec consiga fazer a gerência dos objetos:</p>
<pre><code class="hljs css language-java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Class&lt;Estabelecimento&gt; <span class="hljs-title">getEncoderClass</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> Estabelecimento<span class="hljs-class">.<span class="hljs-keyword">class</span></span>;
}

<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Estabelecimento <span class="hljs-title">generateIdIfAbsentFromDocument</span><span class="hljs-params">(Estabelecimento estabelecimento)</span> </span>{
    <span class="hljs-keyword">return</span> documentHasId(estabelecimento) ? estabelecimento.generateId() : estabelecimento;
}

<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">documentHasId</span><span class="hljs-params">(Estabelecimento estabelecimento)</span> </span>{
    <span class="hljs-keyword">return</span> estabelecimento.getId() == <span class="hljs-keyword">null</span>;
}

<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> BsonValue <span class="hljs-title">getDocumentId</span><span class="hljs-params">(Estabelecimento estabelecimento)</span> </span>{
    <span class="hljs-keyword">if</span> (!documentHasId(estabelecimento)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"This Document do not have a id"</span>);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BsonString(estabelecimento.getId().toHexString());
}
</code></pre>
<p>A única coisa aqui a ressaltar foi a criação do método <em>generateId</em> no model <strong>Estabelecimento</strong> que fica assim:</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">package</span> com.challenge.geolocation.model;
<span class="hljs-keyword">import</span> org.

<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-meta">@Datapublic</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Estabelecimento</span>

    <span class="hljs-title">private</span> <span class="hljs-title">ObjectId</span> <span class="hljs-title">id</span></span>;

    <span class="hljs-keyword">private</span> String nome;
    <span class="hljs-keyword">private</span> String email;
    <span class="hljs-keyword">private</span> Localizacao localizacao;    
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> Estabelecimento <span class="hljs-title">generateId</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }
    
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="repository"></a><a href="#repository" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Repository</h2>
<p>Agora temos o <em>Model</em> e o <em>Codec</em> agora podemos criar o nosso <em>Repository</em> que irá fazer o acesso ao banco e ficará responsável por toda a gerência no Mongo.</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">package</span> com.challenge.geolocation.repository;

<span class="hljs-keyword">import</span> org.springframework.stereotype.Repository;

<span class="hljs-keyword">import</span> com.mongodb.MongoClient;
<span class="hljs-keyword">import</span> com.mongodb.client.MongoDatabase;

<span class="hljs-meta">@Repository</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EstabelecimentoRepository</span> </span>{

    <span class="hljs-keyword">private</span> MongoClient client;
    <span class="hljs-keyword">private</span> MongoDatabase mongoDataBase;

</code></pre>
<p>Aqui criei a classe <strong>EstabelecimentoRepository</strong> e utilizei a annotation <em>@Repository</em> que diz ao <em>Spring</em> que essa classe fará a administração com o banco, aqui já adicionei o <strong>MongoClient</strong> que fará o registro do <em>Codec</em> e fará a conexão ao banco e o <strong>MongoDatabase</strong> que é quem será responsável por nos trazer a instância onde poderemos buscar nas nossos collections e fazer as transações.
Agora vamos abrir a conexão com o banco de dados:</p>
<pre><code class="hljs css language-java">    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"${host}"</span>)
    <span class="hljs-keyword">private</span> String host;

    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"${port}"</span>)
    <span class="hljs-keyword">private</span> String port;

    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"${database}"</span>)
    <span class="hljs-keyword">private</span> String database;

    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"${collection.estabelecimento}"</span>)
    <span class="hljs-keyword">private</span> String estabelecimento;

    <span class="hljs-function"><span class="hljs-keyword">private</span> MongoCollection&lt;Estabelecimento&gt; <span class="hljs-title">openConnetion</span><span class="hljs-params">()</span> </span>{
        Codec&lt;Document&gt; codec = MongoClient.getDefaultCodecRegistry().get(Document<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

        EstabelecimentoCodec estCodec = <span class="hljs-keyword">new</span> EstabelecimentoCodec(codec);

        CodecRegistry registry = CodecRegistries.fromRegistries(MongoClient.getDefaultCodecRegistry(),
                CodecRegistries.fromCodecs(estCodec));

        MongoClientOptions options = MongoClientOptions.builder().codecRegistry(registry).build();

        <span class="hljs-keyword">this</span>.client = <span class="hljs-keyword">new</span> MongoClient(host + <span class="hljs-string">":"</span> + port, options);
        <span class="hljs-keyword">this</span>.mongoDataBase = client.getDatabase(database);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.mongoDataBase.getCollection(<span class="hljs-keyword">this</span>.estabelecimento, Estabelecimento<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">closeConnection</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">this</span>.client.close();
    }
</code></pre>
<p>Fazendo uso da annotation <em>@Valeu</em> do Spring conseguimos recuperar o valor que está no <em>application.yml</em> contendo o <em>host</em>, a <em>port</em>, o <em>database</em> e o nome da <em>collection</em>.
Então basicamente registramos o <em>Codec</em> e conectamos no <strong>Mongo</strong> e já pegamos a nossa <em>collection</em> e já deixamos pronto o método para fechar a conexão.
Agora vamos ao método que vai fazer a busca e agregação desses dados se baseando na proximidade.</p>
<pre><code class="hljs css language-java">
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Estabelecimento&gt; <span class="hljs-title">searchByGeolocation</span><span class="hljs-params">(Filter filter)</span> </span>{
        <span class="hljs-keyword">try</span> {
            MongoCollection&lt;Estabelecimento&gt; estabelecimentoCollection = openConnetion();

            estabelecimentoCollection.createIndex(Indexes.geo2dsphere(<span class="hljs-string">"localizacao"</span>));

            Point referencePoint = <span class="hljs-keyword">new</span> Point(<span class="hljs-keyword">new</span> Position(filter.getLat(), filter.getLng()));

            MongoCursor&lt;Estabelecimento&gt; resultados = estabelecimentoCollection
                    .find(Filters.nearSphere(<span class="hljs-string">"localizacao"</span>, referencePoint, filter.getDistance(), <span class="hljs-number">0.0</span>)).limit(filter.getLimit()).iterator();

            List&lt;Estabelecimento&gt; estabelecimentos = fillEstabelecimento(resultados);

            <span class="hljs-keyword">return</span> estabelecimentos;
        } <span class="hljs-keyword">finally</span> {
            closeConnection();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> List&lt;Estabelecimento&gt; <span class="hljs-title">fillEstabelecimento</span><span class="hljs-params">(MongoCursor&lt;Estabelecimento&gt; resultados)</span> </span>{
        List&lt;Estabelecimento&gt; estabelecimentos = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        <span class="hljs-keyword">while</span> (resultados.hasNext()) {
            estabelecimentos.add(resultados.next());
        }
        <span class="hljs-keyword">return</span> estabelecimentos;
    }
</code></pre>
<p>Então aqui abrimos a conexão com o método <em>openConnetion()</em> que nos devolve a nossa <em>collection</em> e como queremos fazer uma busca por proximidade adicionamos um índice e dizemos que o campo <em>localizacao</em> é do tipo <em>2dsphere</em> se tivessemos usando <strong>Mongo</strong> ficaria assim:</p>
<pre><code class="hljs css language-json">db.estabelcimento.createIndex({
    localizacao : "2dsphere"
})
</code></pre>
<p>Isso o que fizemos é o que o <strong>Mongo</strong> nos obriga a fazer se quisermos fazer a busca por geolocalização.
Em seguida criamos uma classe <strong>Point</strong> que recebe a <em>latitude</em> e a <em>longitude</em> e que será a baseado no nosso endereço quando passarmos. Como pegar a nossa latitude e longitude? Não se preocupe que iremos ver mais a seguir no momento só entenda que teremos esses valores pois é assim que poderemos trabalhar com geolocalização.
Agora podemos disparar a nossa pesquisa:</p>
<pre><code class="hljs css language-java">MongoCursor&lt;Estabelecimento&gt; resultados = estabelecimentoCollection
                    .find(Filters.nearSphere(<span class="hljs-string">"localizacao"</span>, referencePoint, filter.getDistance(), <span class="hljs-number">0.0</span>)).limit(filter.getLimit()).iterator();
</code></pre>
<p>Aqui está a nossa busca, temos a nossa <em>collection</em> e usamos o método <em>find</em> só que passamos dentro dele os nossos filtros para a agregação com a classe <strong>Filter</strong> e seu método estático <em>nearSphere</em> que ele recebe o campo onde ele vai fazer a busca que no caso é <em>localizacao</em> o ponto de referencia que é o nosso <em>referencePoint</em> que nós criamos com a <em>latitude</em> e <em>longitude</em>, a máxima distância, em metros, da nossa pesquisa e a mínima distância; também passamos o <em>limit</em> de resultados e chamamos o <em>iterator</em> para podermos percorrers o que nos voltar do <strong>Mongo</strong>.
Com um <strong>Iterator</strong> de resultados em mão podemos então percorrer o resultado, aqui separei no método <em>fillEstabelecimento</em> que devolve uma lista de <strong>Estabelecimento</strong>:</p>
<pre><code class="hljs css language-java">    <span class="hljs-function"><span class="hljs-keyword">private</span> List&lt;Estabelecimento&gt; <span class="hljs-title">fillEstabelecimento</span><span class="hljs-params">(MongoCursor&lt;Estabelecimento&gt; resultados)</span> </span>{
        List&lt;Estabelecimento&gt; estabelecimentos = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        <span class="hljs-keyword">while</span> (resultados.hasNext()) {
            estabelecimentos.add(resultados.next());
        }
        <span class="hljs-keyword">return</span> estabelecimentos;
    }
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="service"></a><a href="#service" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Service</h2>
<p>Agora faremos a classe de serviço, que irá executar a nossa consulta ao banco através do <em>Repository</em> e que irá ser chamada pela nossa <em>Controller</em> que nos passará o endereço e nós iremos fazer a transformação dele em <em>latitude</em> e <em>longitude</em>, para isso usaremos a dependência <em>Google Maps</em> mas antes disso teremos que nos registrar no <strong>GCP - Google Cloud Platform</strong>, para isso será necessário criar um conta lá, não se preocupe com isso pois o <strong>Google</strong> dará um valor em créditos caso seja seu primeiro registro e após isso não cobrará nada sem seu consentimento prévio, após criar a conta acesse o <strong>Console</strong> habilitar a API <strong>Geocoding API</strong>:</p>
<p><img src="/blog-guilherme/blog/assets/gcp-geocoding-api.png" alt=""></p>
<p>Após isso é necessário criar uma <strong>Apikey</strong> para que a sua aplicação possa se comunicar com o serviço que foi habilitado:</p>
<p><img src="/blog-guilherme/blog/assets/api-key-geo.png" alt=""></p>
<p>Agora a nossa apikey em mão já podmos começar a criar a classe <strong>EstabelecimentoService</strong>:</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">package</span> com.challenge.geolocation.service;

<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;

<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> com.challenge.geolocation.dto.EstabelecimentoDTO;
<span class="hljs-keyword">import</span> com.challenge.geolocation.filter.Filter;
<span class="hljs-keyword">import</span> com.challenge.geolocation.model.Estabelecimento;
<span class="hljs-keyword">import</span> com.challenge.geolocation.repository.EstabelecimentoRepository;
<span class="hljs-keyword">import</span> com.google.maps.GeoApiContext;
<span class="hljs-keyword">import</span> com.google.maps.GeocodingApi;
<span class="hljs-keyword">import</span> com.google.maps.GeocodingApiRequest;
<span class="hljs-keyword">import</span> com.google.maps.errors.ApiException;
<span class="hljs-keyword">import</span> com.google.maps.model.GeocodingResult;
<span class="hljs-keyword">import</span> com.google.maps.model.Geometry;
<span class="hljs-keyword">import</span> com.google.maps.model.LatLng;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EstabelecimentoService</span> </span>{

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> EstabelecimentoRepository repository;

    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"${apikey}"</span>)
    <span class="hljs-keyword">private</span> String apikey;

    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;EstabelecimentoDTO&gt; <span class="hljs-title">procuraEstabelecimentosProximoAMim</span><span class="hljs-params">(String endereco, String distance, String limit)</span> </span>{

        GeoApiContext context = <span class="hljs-keyword">new</span> GeoApiContext.Builder().apiKey(apikey).build();

        GeocodingApiRequest request = GeocodingApi.newRequest(context).address(endereco);

        <span class="hljs-keyword">try</span> {
            GeocodingResult[] results = request.await();
            GeocodingResult resultado = results[<span class="hljs-number">0</span>];
            
            Geometry geometry = resultado.geometry;
            
            LatLng location = geometry.location;
            
            List&lt;Estabelecimento&gt; estabelecimentoList = repository.searchByGeolocation(
                    Filter.toFilter(location.lat, location.lng, Double.valueOf(distance), Integer.valueOf(limit)));
            
            List&lt;EstabelecimentoDTO&gt; dtoList = estabelecimentoList.stream().map(estabelecimento -&gt; {
                <span class="hljs-keyword">return</span> EstabelecimentoDTO.toDTO(estabelecimento);
            }).collect(Collectors.toList());
            
            <span class="hljs-keyword">return</span> dtoList;
        } <span class="hljs-keyword">catch</span> (ApiException | InterruptedException | IOException e) {
            e.printStackTrace();
        }

        <span class="hljs-keyword">return</span> List.of();
    }
}

</code></pre>
<p>Criamos o método <em>procuraEstabelecimentosProximoAMim</em> que recebe o <em>endereco</em>, a <em>distance</em> e o <em>limit</em>, em seguida criamos <strong>GeoApiContext</strong> usando a nossa <em>apikey</em> fazemos a nossa requisição para a o serviço do Google passando o nosso endereço como estamos fazendo tudo isso de forma síncrona ficamos esperando o retorno do serviço externo, isso por si só pode ocasionar muitos problema então todo o método <em>await</em> lança <strong>Exceptions</strong> que aqui não vamos nos aprofundar tratando-as.
Após o retorno pegamos o resultado e navegamos no objeto de retorno até chegarmos onde queremos que é na <em>location</em> que é onde ele guarda a latitude e a longitude e agora podemos chamar o nosso <em>Repository</em> que irá executar a nossa busca.</p>
<h2><a class="anchor" aria-hidden="true" id="filter"></a><a href="#filter" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Filter</h2>
<p>Um ponto de observação, você deve ter notado a classe <em>Filter</em> e o método <em>toFilter</em> na nossa <strong>Service</strong> e na <strong>Repository</strong> o <em>Filter</em> com <em>getLat</em>, <em>getLng</em>, <em>getDistance</em> e <em>getLimit</em>. Ele nos ajuda a não passar um valor muito grande variáveis na chamada de um método, segue:</p>
<pre><code class="hljs css language-java"><span class="hljs-meta">@Getter</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Filter</span> </span>{
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Filter</span><span class="hljs-params">()</span> </span>{}
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">double</span> lat;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">double</span> lng;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">double</span> distance;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> limit;
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Filter <span class="hljs-title">toFilter</span><span class="hljs-params">(<span class="hljs-keyword">double</span> latitude, <span class="hljs-keyword">double</span> longitude, <span class="hljs-keyword">double</span> distance, <span class="hljs-keyword">int</span> limit)</span> </span>{
        Filter filter = <span class="hljs-keyword">new</span> Filter();
        filter.lat = latitude;
        filter.lng = longitude;
        filter.distance = distance == <span class="hljs-number">0</span> ? <span class="hljs-number">1000.0</span> : distance;
        filter.limit = limit == <span class="hljs-number">0</span> ? <span class="hljs-number">10</span> : limit;     
        
        <span class="hljs-keyword">return</span> filter;
    }

}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="controller"></a><a href="#controller" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Controller</h2>
<p>Agora iremos criar a nossa <em>Controller</em> onde receberemos a requisição e devolveremos o resultado da pesquisa.</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">package</span> com.challenge.geolocation.controller;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;

<span class="hljs-keyword">import</span> com.challenge.geolocation.dto.EstabelecimentoDTO;
<span class="hljs-keyword">import</span> com.challenge.geolocation.service.EstabelecimentoService;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"api"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EstabalecimentoController</span> </span>{

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> EstabelecimentoService service;

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"estabelecimento"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;EstabelecimentoDTO&gt; <span class="hljs-title">pegaEstabelecimentosProximosPeloEndereco</span><span class="hljs-params">(
            @RequestParam(name = <span class="hljs-string">"limit"</span>, defaultValue = <span class="hljs-string">"10"</span>)</span> String limit,
            @<span class="hljs-title">RequestParam</span><span class="hljs-params">(name = <span class="hljs-string">"distancia"</span>, defaultValue = <span class="hljs-string">"1000.00"</span>)</span> String distancia,
            @<span class="hljs-title">RequestParam</span><span class="hljs-params">(<span class="hljs-string">"endereco"</span>)</span> String endereco) </span>{
        <span class="hljs-keyword">return</span> service.procuraEstabelecimentosProximoAMim(endereco, distancia, limit);
    }

}
</code></pre>
<p>Temos aqui a nossa <strong>EstabalecimentoController</strong> com unm método <em>pegaEstabelecimentosProximosPeloEndereco</em> e os parâmetros <em>limit</em> com um valor default de 10 caso não seja específicado na url, <em>distancia</em> com o valor de 1000.00, valor em metros e <em>endereco</em>.
Uma coisa interessante é que a nossa <em>Controller</em> não devolve o nosso <em>Model</em> pois não é considerado uma boa prática e até mesmo um falha de segurança dependedo da situação então o que devolvemos? Devolvemos um <strong>DTO</strong> (<em>Data Transfer Object</em>) que é um objeto <strong>POJO</strong> que só trafega dados como no exemplo:</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">package</span> com.challenge.geolocation.dto;

<span class="hljs-keyword">import</span> com.challenge.geolocation.model.Estabelecimento;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect.Visibility;

<span class="hljs-keyword">import</span> lombok.Getter;

<span class="hljs-meta">@JsonAutoDetect</span>(fieldVisibility = Visibility.ANY, getterVisibility = Visibility.NONE, setterVisibility = Visibility.NONE)
<span class="hljs-meta">@Getter</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EstabelecimentoDTO</span> </span>{
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">EstabelecimentoDTO</span><span class="hljs-params">()</span> </span>{}
    
    <span class="hljs-keyword">private</span> String nome;
    <span class="hljs-keyword">private</span> String email;
    <span class="hljs-keyword">private</span> String endereco;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> EstabelecimentoDTO <span class="hljs-title">toDTO</span><span class="hljs-params">(Estabelecimento estabelecimento)</span> </span>{
        EstabelecimentoDTO dto = <span class="hljs-keyword">new</span> EstabelecimentoDTO();
        
        dto.nome = estabelecimento.getNome();
        dto.email = estabelecimento.getEmail();
        dto.endereco = estabelecimento.getLocalizacao().getEndereco();      
        
        <span class="hljs-keyword">return</span> dto;
    }
}
</code></pre>
<p>A única responsabilidade desse DTO é transformar um <strong>Estabelecimento</strong> em um DTO para ser retornado para a <em>Controller</em> e isso é feito dentro da nossa classe de <em>Service</em> no retorno da nossa <em>Repository</em>.</p>
<h2><a class="anchor" aria-hidden="true" id="resultado-final"></a><a href="#resultado-final" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Resultado final</h2>
<p>Antes de testarmos precisamos fazer a inclusão de dados, então podemos inserir no Mongo os dados:</p>
<pre><code class="hljs css language-json">{
    <span class="hljs-attr">"nome"</span> : <span class="hljs-string">"Mercado I"</span>,
    <span class="hljs-attr">"email"</span> : <span class="hljs-string">"contato@mercadoI.com"</span>,
    <span class="hljs-attr">"localizacao"</span> : {
        <span class="hljs-attr">"endereco"</span> : <span class="hljs-string">"Rua Brigadeiro Tobias n 780"</span>,
        <span class="hljs-attr">"coordinates"</span> : [ 
            <span class="hljs-number">-23.53624</span>, 
            <span class="hljs-number">-46.63395</span>
        ],
        <span class="hljs-attr">"type"</span> : <span class="hljs-string">"Point"</span>
    }
}

{    
    <span class="hljs-attr">"nome"</span> : <span class="hljs-string">"Estabelecimento II"</span>,
    <span class="hljs-attr">"email"</span> : <span class="hljs-string">"contato@mercadoII.com"</span>,
    <span class="hljs-attr">"localizacao"</span> : {
        <span class="hljs-attr">"endereco"</span> : <span class="hljs-string">"R. Brg. Tobias, 206 - Santa Ifigênia, São Paulo - SP, 01032-000"</span>,
        <span class="hljs-attr">"coordinates"</span> : [ 
            <span class="hljs-number">-23.54165</span>, 
            <span class="hljs-number">-46.63583</span>
        ],
        <span class="hljs-attr">"type"</span> : <span class="hljs-string">"Point"</span>
    }
}

{    
    <span class="hljs-attr">"nome"</span> : <span class="hljs-string">"Estabelecimento III"</span>,
    <span class="hljs-attr">"email"</span> : <span class="hljs-string">"contato@mercadoIII.com"</span>,
    <span class="hljs-attr">"localizacao"</span> : {
        <span class="hljs-attr">"endereco"</span> : <span class="hljs-string">"Av. Cásper Líbero, 42 - Centro Histórico De São Paulo, São Paulo - SP, 01033-000"</span>,
        <span class="hljs-attr">"coordinates"</span> : [ 
            <span class="hljs-number">-23.54132</span>, 
            <span class="hljs-number">-46.63643</span>
        ],
        <span class="hljs-attr">"type"</span> : <span class="hljs-string">"Point"</span>
    }
}

{    
    <span class="hljs-attr">"nome"</span> : <span class="hljs-string">"Estabelecimento IV"</span>,
    <span class="hljs-attr">"email"</span> : <span class="hljs-string">"contato@mercadoIV.com"</span>,
    <span class="hljs-attr">"localizacao"</span> : {
        <span class="hljs-attr">"endereco"</span> : <span class="hljs-string">"Av. Rio Branco, 630 - República, São Paulo - SP, 01205-000"</span>,
        <span class="hljs-attr">"coordinates"</span> : [ 
            <span class="hljs-number">-23.53984</span>, 
            <span class="hljs-number">-46.64008</span>
        ],
        <span class="hljs-attr">"type"</span> : <span class="hljs-string">"Point"</span>
    }
}

{    
    <span class="hljs-attr">"nome"</span> : <span class="hljs-string">"Estabelecimento V"</span>,
    <span class="hljs-attr">"email"</span> : <span class="hljs-string">"contato@mercadoV.com"</span>,
    <span class="hljs-attr">"localizacao"</span> : {
        <span class="hljs-attr">"endereco"</span> : <span class="hljs-string">"Alameda Barão de Limeira, 425 - Campos Elíseos, São Paulo - SP, 01202-900"</span>,
        <span class="hljs-attr">"coordinates"</span> : [ 
            <span class="hljs-number">-23.53386</span>, 
            <span class="hljs-number">-46.6482</span>
        ],
        <span class="hljs-attr">"type"</span> : <span class="hljs-string">"Point"</span>
    }
}

{    
    <span class="hljs-attr">"nome"</span> : <span class="hljs-string">"Estabelecimento VI"</span>,
    <span class="hljs-attr">"email"</span> : <span class="hljs-string">"contato@mercadoVI.com"</span>,
    <span class="hljs-attr">"localizacao"</span> : {
        <span class="hljs-attr">"endereco"</span> : <span class="hljs-string">"R. Canuto do Val, 41 - Santa Cecilia, São Paulo - SP, 01224-040"</span>,
        <span class="hljs-attr">"coordinates"</span> : [ 
            <span class="hljs-number">-23.54062</span>, 
            <span class="hljs-number">-46.65114</span>
        ],
        <span class="hljs-attr">"type"</span> : <span class="hljs-string">"Point"</span>
    }
}

</code></pre>
<p>Agora vamos fazer um teste manual usando o <em>Insomnia</em> um client para requisições HTTP, mas você usar qualquer um de sua prefência, PostMan, PostWoman, cUrl e etc.</p>
<p><img src="/blog-guilherme/blog/assets/teste-geo.png" alt=""></p>
<p>Então fazendo a requisição <em><a href="http://localhost:8080/api/estabelecimento?endereco=R">http://localhost:8080/api/estabelecimento?endereco=R</a>. Brg. Tobias, 247</em>
Temos a reposta:</p>
<pre><code class="hljs css language-json">[
  {
    <span class="hljs-attr">"nome"</span>: <span class="hljs-string">"Estabelecimento II"</span>,
    <span class="hljs-attr">"email"</span>: <span class="hljs-string">"contato@mercadoII.com"</span>,
    <span class="hljs-attr">"endereco"</span>: <span class="hljs-string">"R. Brg. Tobias, 206 - Santa Ifigênia, São Paulo - SP, 01032-000"</span>
  },
  {
    <span class="hljs-attr">"nome"</span>: <span class="hljs-string">"Estabelecimento III"</span>,
    <span class="hljs-attr">"email"</span>: <span class="hljs-string">"contato@mercadoIII.com"</span>,
    <span class="hljs-attr">"endereco"</span>: <span class="hljs-string">"Av. Cásper Líbero, 42 - Centro Histórico De São Paulo, São Paulo - SP, 01033-000"</span>
  },
  {
    <span class="hljs-attr">"nome"</span>: <span class="hljs-string">"Mercado I"</span>,
    <span class="hljs-attr">"email"</span>: <span class="hljs-string">"contato@mercadoI.com"</span>,
    <span class="hljs-attr">"endereco"</span>: <span class="hljs-string">"Rua Brigadeiro Tobias n 780"</span>
  },
  {
    <span class="hljs-attr">"nome"</span>: <span class="hljs-string">"Estabelecimento IV"</span>,
    <span class="hljs-attr">"email"</span>: <span class="hljs-string">"contato@mercadoIV.com"</span>,
    <span class="hljs-attr">"endereco"</span>: <span class="hljs-string">"Av. Rio Branco, 630 - República, São Paulo - SP, 01205-000"</span>
  }
]
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="projeto-final"></a><a href="#projeto-final" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Projeto Final</h2>
<p>O projeto final você pode encontrar aqui <a href="https://github.com/guilhermegarcia86/geolocation">aqui</a></p>
</span></div></article></div><div class="post"><header class="postHeader"><h1 class="postHeaderTitle"><a href="/blog-guilherme/blog/2020/04/24/post-s3">AWS S3</a></h1><p class="post-meta">April 24, 2020</p><div class="authorBlock"><p class="post-authorName"><a href="https://twitter.com/guilherme_ga86" target="_blank" rel="noreferrer noopener">Guilherme Alves</a></p><div class="authorPhoto"><a href="https://twitter.com/guilherme_ga86" target="_blank" rel="noreferrer noopener"><img src="https://graph.facebook.com/1426803577/picture/?height=200&amp;width=200" alt="Guilherme Alves"/></a></div></div></header><article class="post-content"><div><span><h1><a class="anchor" aria-hidden="true" id="aws-s3"></a><a href="#aws-s3" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>AWS S3</h1>
<p><strong>Conceito inicial</strong></p>
<p>Serviço de armazenamento de objetos, podendo ser arquivos, imagens e etc.</p>
<p>Criar S3 é simples pois a interface da AWS é amigável e podemos iniciar um bucket, que é agregador de arquivos (objetos) como as configurações padrões e depois mudar conforme necessidade a única coisa que não é permitido mudar é o nome, tendo o nome de ser único e seguindo algumas regras de validação na hora da criação do bucket.</p>
<p><strong>Static Web</strong></p>
<p>Temos a possibilidade de configurar o S3 para ser um servidor simples de páginas estáticas.</p>
<p>Basta habilitar a opção no bucket e configurar qual será a página estática e página de erro, fazer o upload delas e fazer as configurações de permissão do arquivo.</p>
<p><strong>Command Line</strong></p>
<p>Ferramenta que serve para automatização de processos na AWS, não é exclusivo do S3 serve para uma série de serviços na AWS.</p>
<p>É necessário configurar a segurança no cli, podendo ser por um usuário root (a maneira mais simples porém mais frágil pois gera um par de chave:senha que caso seja perdido ou usado por outro cli não como saber) ou configuração no IAM para configurações de grupos e usuários.</p>
<p>Comandos:</p>
<p><strong>BUCKET</strong></p>
<pre><code class="hljs"><span class="hljs-symbol">aws</span> <span class="hljs-built_in">s3</span> mb (make_bucket) <span class="hljs-built_in">s3</span>://nome &lt;CRIA&gt;

<span class="hljs-symbol">aws</span> <span class="hljs-built_in">s3</span> rb (remove_bucket) nome &lt;REMOVE VAZIO&gt; opção --force remove tudo

<span class="hljs-symbol">aws</span> <span class="hljs-built_in">s3</span> ls <span class="hljs-built_in">s3</span>://NOME &lt;LISTA O CONTEUDO DO <span class="hljs-keyword">BUCKET&gt;
</span></code></pre>
<p><strong>OBJETOS</strong></p>
<pre><code class="hljs"><span class="hljs-symbol">aws</span> <span class="hljs-built_in">s3</span> <span class="hljs-meta">cp</span> <span class="hljs-built_in">s3</span>://nomeBucket/objetoNome.extenssão . (dowload do objeto na máquina)

<span class="hljs-symbol">aws</span> <span class="hljs-built_in">s3</span> <span class="hljs-meta">cp</span> nomeArquivo <span class="hljs-built_in">s3</span>://<span class="hljs-keyword">bucket </span>(upload no <span class="hljs-keyword">bucket </span>específico)

<span class="hljs-symbol">aws</span> <span class="hljs-built_in">s3</span> rm <span class="hljs-built_in">s3</span>://<span class="hljs-keyword">bucket/arquivo </span>(removo do <span class="hljs-keyword">bucket </span>o arquivo)

<span class="hljs-symbol">aws</span> <span class="hljs-built_in">s3</span> mv <span class="hljs-built_in">s3</span>://<span class="hljs-keyword">bucket/arquivo </span><span class="hljs-built_in">s3</span>://<span class="hljs-keyword">bucket/novoNomeArquivo </span>(renomeia arquivo)

<span class="hljs-symbol">aws</span> <span class="hljs-built_in">s3</span> sync <span class="hljs-built_in">s3</span>://<span class="hljs-keyword">bucket </span>nomePastaLocal (sincroniza ambientes a partir do <span class="hljs-keyword">bucket)
</span>
<span class="hljs-symbol">aws</span> <span class="hljs-built_in">s3</span> sync . <span class="hljs-built_in">s3</span>://<span class="hljs-keyword">bucket </span>(sincroniza ambientes a partir do local)
</code></pre>
<p>P.S.: No caso de delete deve adicionar a flag --delete</p>
<h2><a class="anchor" aria-hidden="true" id="política-de-acesso-a-grupos-de-usuários"></a><a href="#política-de-acesso-a-grupos-de-usuários" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Política de acesso a grupos de usuários</h2>
<p><strong>Serviço IAM</strong></p>
<p>Configuração via wizard na AWS, nele é possível criar um usuário, um grupo de usuários e definir os acessos aos serviços na AWS.</p>
<p>No IAM é possível dar acesso total ou fazer refinamento de acessos, para leitura, edição e etc., porém para fazer esse refinamento é necessário mais configurações no IAM pois neste caso do S2 conseguimos fazer com que o um grupo consigo listar os buckets definindo a política AllowListBuckets:</p>
<pre><code class="hljs">{

    <span class="hljs-attr">"Version"</span>: <span class="hljs-string">"2012-10-17"</span>,

    <span class="hljs-attr">"Statement"</span>: [

        {

            <span class="hljs-attr">"Sid"</span>: <span class="hljs-string">"Stmt1505251989000"</span>,

            <span class="hljs-attr">"Effect"</span>: <span class="hljs-string">"Allow"</span>,

            <span class="hljs-attr">"Action"</span>: [

                <span class="hljs-string">"s3:ListAllMyBuckets"</span>

            ],

            <span class="hljs-attr">"Resource"</span>: [

                <span class="hljs-string">"arn:aws:s3:::*"</span>

            ]

        }

    ]

}
</code></pre>
<p>E com isso o usuário desse grupo consegue listar os buckets mas perde o acesso a ver o conteúdo dos buckets e é necessário dar permissão de visualizar o conteúdo adicionando uma política AllowAccesBucket:</p>
<pre><code class="hljs">{

    <span class="hljs-attr">"Version"</span>: <span class="hljs-string">"2012-10-17"</span>,

    <span class="hljs-attr">"Statement"</span>: [

        {

            <span class="hljs-attr">"Sid"</span>: <span class="hljs-string">"Stmt1505254613000"</span>,

            <span class="hljs-attr">"Effect"</span>: <span class="hljs-string">"Allow"</span>,

            <span class="hljs-attr">"Action"</span>: [

                <span class="hljs-string">"s3:*"</span>

            ],

            <span class="hljs-attr">"Resource"</span>: [

                <span class="hljs-string">"arn:aws:s3:::alura-s3"</span>, <span class="hljs-comment">// Garante acesso ao bucket</span>

                <span class="hljs-string">"arn:aws:s3:::alura-s3/*"</span> <span class="hljs-comment">// Concede privilegio ao conteúdo para escrita e edição</span>

            ]

        }

    ]

}
</code></pre>
<p>E com isso o usuário tem acesso a ver conteúdo do bucket e tem privilégio de escrita e edição.</p>
<p><strong>SDK</strong></p>
<p>Ferramenta desenvolvida pela AWS para podermos de forma programática acessar os recursos, neste caso será usado para o S3, podemos com ele fazer as operações dentro de uma aplicação como upload, delete, leitura e etc.</p>
<p><strong>Versionamento</strong></p>
<p>Habilitar versionamento via console.</p>
<p>Classes de armazenamento</p>
<p>Standard - mais rápida (arquivos constantemente usados)</p>
<p>Standard-IA - igual ao Standard porém com regras de armazenamento e taxa de recuperação (usado para arquivos que não usados com tanta frequência)</p>
<p>Glacier - mais lento (arquivos não usados com frequência - backups e etc.)</p>
<p>Ciclo de vida</p>
<p>Exemplo:</p>
<p>0 dia Arquivo Standard -&gt; 30 dias Arquivo Standard-IA -&gt; 60 dias Arquivo Glacier -&gt; 365 dias Expiração Deleção</p>
<p>Amazon S3 -&gt;  Escolher Bucket -&gt; Aba Management -&gt; Button Add lifecycle rule -&gt; Wizard:</p>
<ol>
<li><p>Rule Name</p></li>
<li><p>Add filter by tag or prefix</p></li>
<li><p>Configure transition, can be for current version or previous versions or both.</p></li>
<li><p>Add transition, configure after 30 days go to Standard-IA and after 60 days go to Glacier</p></li>
<li><p>Configure expiration, after 365 days expire.</p></li>
</ol>
</span></div></article></div><div class="post"><header class="postHeader"><h1 class="postHeaderTitle"><a href="/blog-guilherme/blog/2020/04/24/post-ecs">AWS ECS</a></h1><p class="post-meta">April 24, 2020</p><div class="authorBlock"><p class="post-authorName"><a href="https://twitter.com/guilherme_ga86" target="_blank" rel="noreferrer noopener">Guilherme Alves</a></p><div class="authorPhoto"><a href="https://twitter.com/guilherme_ga86" target="_blank" rel="noreferrer noopener"><img src="https://graph.facebook.com/1426803577/picture/?height=200&amp;width=200" alt="Guilherme Alves"/></a></div></div></header><article class="post-content"><div><span><p><strong>Elastic Container Service</strong></p>
<p>O Amazon Elastic Container Service (<strong>ECS</strong>) é um serviço de orquestração de contêineres.</p>
<p><img src="/blog-guilherme/blog/assets/visao-geral.png" alt=""></p>
<p>Camadas:</p>
<ol>
<li><p>Container - Onde fica a sua imagem (aplicação) imagem Docker</p></li>
<li><p>Task - Parâmetros para a imagem rodar (memória, cpu e etc)</p></li>
<li><p>Service - É onde fica a administração de instâncias</p></li>
<li><p>Cluster - Agrupamento de instâncias (EC2 ou Fargate)</p></li>
</ol>
<p>O serviço ECS pode ser criado com EC2 ou Fargate. Porém o serviço do Fargate é mais genérico e mais simples com o EC2 temos acesso as máquina que são criadas.</p>
<p><strong>Fargate</strong></p>
<p>AWS Fargate o &quot;gerenciador&quot; da infraestrutra que roda os containers. O Fargate decide quais maquinas a usar, tipo de servers e como escalar. No modelo <strong>Fargate</strong>, toda a infraestrutura é provisionada e gerenciada automaticamente pela AWS, diferentemente do modelo EC2.</p>
<p>Na criação do cluster pelo serviço do Fargate ele cria toda a parte de rede pra nós automaticamente que são conceitos que estão no VPC que são as faixas de rede nas quais a instancias estão associadas. Então ele cria tudo automaticamente como por exemplo o range da rede, as sub-redes, o security group que é onde estão as regras para permitir os tipos de acesso que queremos dar para as aplicações, por exemplo se criarmos o aplicação de exemplo do ECS com Fargate essa aplicação vai atender a porta 80 por que ele adiciona essa regra na criação.</p>
<p><strong>Parando o container</strong></p>
<p>No console Amazon se tentarmos para a Task ele nos dará uma mensagem de que o Service foi iniciado por um processo aotumatizado e que se quisermos parar é necessário atualizar (update) a Service, isso acontece por que quando criamos o ECS ele cria com o um número padrão de Taks's, 1 no caso, então se pararmos o serviço assim ele irpa se reiniciar na sequência, para mudar issso então entramos na parte de Service e atualizamos para 0 o número de Task's.</p>
<p><strong>Agora fazendo isso pelo CLI.</strong></p>
<p><a href="https://docs.aws.amazon.com/pt_br/cli/latest/userguide/install-cliv2-linux.html#cliv2-linux-prereq">Instalar CLI AWS Linux</a></p>
<p>Após a instalação é necessário fazer a configuração através do comando: aws configure</p>
<p>Aqui será pedido os dados de <strong>Access Key ID</strong>, <strong>Secret Access Key</strong> e <strong>region</strong>; para os dados Access é necessário já ter a configuração de <strong>user</strong> e <strong>security group</strong>.</p>
<p>Para fazer por linha de comando com cli da <strong>aws</strong> é só usar o comando <strong>update-service --service</strong> e o nome do serviço <strong>--desired-count 0</strong> aqui é atualizado o número para zero igual fizemos no console na página da AWS aqui também podemos incrementar outros valores se quiséssemos aumentar o número de serviços.</p>
<pre><code class="hljs">aws <span class="hljs-keyword">update</span>-service --service <span class="hljs-keyword">sample</span>-<span class="hljs-keyword">app</span>-service --desired-<span class="hljs-keyword">count</span> 0
</code></pre>
<p>Outros comandos no aws cli:</p>
<pre><code class="hljs"><span class="hljs-string">aws </span><span class="hljs-string">ecs </span><span class="hljs-built_in">list-cluters</span> //<span class="hljs-string">lista </span><span class="hljs-string">clusters
</span>
<span class="hljs-string">aws </span><span class="hljs-string">ecs </span><span class="hljs-built_in">list-services</span> //<span class="hljs-string">lista </span><span class="hljs-string">serviç</span><span class="hljs-string">os </span><span class="hljs-string">do </span><span class="hljs-string">cluster </span><span class="hljs-string">default
</span>
<span class="hljs-string">aws </span><span class="hljs-string">ecs </span><span class="hljs-built_in">list-services</span> <span class="hljs-built_in">--cluster</span> &lt;<span class="hljs-string">nome-do-</span><span class="hljs-string">cluster&gt;</span> //<span class="hljs-string">lista </span><span class="hljs-string">os </span><span class="hljs-string">serviç</span><span class="hljs-string">os </span><span class="hljs-string">do </span><span class="hljs-string">cluster </span><span class="hljs-string">com </span>o <span class="hljs-string">nome </span><span class="hljs-string">que </span><span class="hljs-string">for </span><span class="hljs-string">passado
</span>
<span class="hljs-string">aws </span><span class="hljs-string">ecs </span><span class="hljs-built_in">list-tasks</span> //<span class="hljs-string">lista </span><span class="hljs-string">tasks
</span>
<span class="hljs-string">aws </span><span class="hljs-string">ecs </span><span class="hljs-string">describe-cluters </span>//<span class="hljs-string">info </span><span class="hljs-string">dos </span><span class="hljs-string">cluters </span><span class="hljs-string">mostrando </span><span class="hljs-string">as </span><span class="hljs-string">tarefas </span><span class="hljs-string">em </span><span class="hljs-string">execuç</span>ão
</code></pre>
<p><strong>Querys</strong></p>
<p>Buscando informações de todos os clusters:</p>
<pre><code class="hljs">aws ecs <span class="hljs-meta">describe</span>-clusters --query <span class="hljs-string">'clusters[*].[clusterNmae,runningTasksCount]'</span> //todos os clusters pegar o nome e <span class="hljs-meta">as</span> tasks rodando
</code></pre>
<p>Buscando todas as informações de uma task</p>
<pre><code class="hljs">aws ecs <span class="hljs-keyword">describe</span>-tasks --<span class="hljs-keyword">cluster</span> &lt;nome-<span class="hljs-keyword">do</span>-<span class="hljs-keyword">cluster</span>&gt; --tasks &lt;id-task&gt; --<span class="hljs-keyword">query</span> 'tasks[*].{cpu:cpu,memoria:<span class="hljs-keyword">memory</span>}'
</code></pre>
<p><strong>EC2 Criando ECS</strong></p>
<p>No console na página da AWS em Clusters clicar em Create Cluster</p>
<p><img src="/blog-guilherme/blog/assets/cluster-ptI.png" alt=""></p>
<p>Na próxima tela clicar em EC2 Linux + Networking</p>
<p><img src="/blog-guilherme/blog/assets/clusterII.png" alt=""></p>
<p>Aqui definimos o nome do cluster, deixamos a opção On-Demand (onde ele vai cobrar sobre demanda então é bom ter cuidado aqui), escolhemos a EC2 instance type para t2.micro, opção gratuita e Number of instances como 2.</p>
<p><img src="/blog-guilherme/blog/assets/clusterIII.png" alt=""></p>
<p>Aqui deixamos o padrão de disco como 22GB e definir a key pair, caso não possua é necessário gerar uma no EC2 Console.</p>
<p><img src="/blog-guilherme/blog/assets/clusterIV.png" alt=""></p>
<p>Criando uma key pair no Ec2 console. Clicar em Create Key Pair</p>
<p><img src="/blog-guilherme/blog/assets/clusterV.png" alt=""></p>
<p>Escolher o nome da key pair e o tipo, para linux escolher pem e Windows ppk e depois Create key pair</p>
<p><img src="/blog-guilherme/blog/assets/clusterVI.png" alt=""></p>
<p>Em Networking podemos escolher a VPC, subnets e security group. Aqui cosneguimos selecionar as que foram criadas por padrão quando criamos o cluster com o Fargate.</p>
<p><img src="/blog-guilherme/blog/assets/clusterVII.png" alt=""></p>
<p>E por fim clicar em Create, ele vai fazer toda a configuração.</p>
<p>Feito tudo isso podemos entrar no console do EC2 e temos todas as configurações feitas e as instâncias no ar, com os volumes configurados, o security group configurado e o auto scaling habilitado, realizando o teste e terminando uma das instâncias demorou em torno de dois minutos mas ele subiu uma nova instância de EC2.</p>
<p><strong>Provisionando mais instâncias</strong></p>
<p>No console do EC2 clicando em Auto Scaling Group</p>
<p><img src="/blog-guilherme/blog/assets/provI.png" alt=""></p>
<p>Selecionando o grupo e após em Actions e depois Edit</p>
<p><img src="/blog-guilherme/blog/assets/provII.png" alt=""></p>
<p>Conseguimos aumentar o número de instâncias</p>
<p><img src="/blog-guilherme/blog/assets/ecrI.png" alt=""></p>
<p>Agora fazendo esse processo por linha de comando.</p>
<pre><code class="hljs"><span class="hljs-string">aws </span><span class="hljs-string">autoscaling </span><span class="hljs-built_in">set-desired-capacity</span> <span class="hljs-built_in">--auto-scaling-group-name</span> <span class="hljs-string">EC2ContainerService-ecs-</span><span class="hljs-string">api-EcsInstanceAsg-</span><span class="hljs-string">3TJFN8LSM6G1 </span><span class="hljs-built_in">--desired-capacity</span> 2

<span class="hljs-string">aws </span><span class="hljs-string">autoscaling </span><span class="hljs-string">describe-auto-</span><span class="hljs-string">scalling-groups </span>//<span class="hljs-string">lista </span><span class="hljs-string">informaç</span>õ<span class="hljs-string">es
</span></code></pre>
<p><strong>Elastic Container Registry (ECR)</strong></p>
<p>É um registry privado de containers Docker da AWS, as imagens são armazenadas com compressão de dados, o que resulta em uma vantagem financeira, já que o serviço é cobrado por espaço utilizado e através do IAM é possível vincular usuários e políticas para implementar controle de acesso ao ECR.</p>
<ul>
<li>fazer um pull local de imagem</li>
</ul>
<p>docker pull rmerces/api-monolitica</p>
<ul>
<li><p>criar um repositório de imagens no ECR</p></li>
<li><p>No console da AWS no serviço ECS tem no menu do serviço a opção Repository</p></li>
<li><p>Nele é clicar em criar repository e nomear</p></li>
<li><p>Comando para fazer o push da imagem</p></li>
</ul>
<pre><code class="hljs"><span class="hljs-string">aws </span><span class="hljs-string">ecr </span><span class="hljs-built_in">get-login-password</span> <span class="hljs-built_in">--region</span> <span class="hljs-string">us-east-</span>1 | <span class="hljs-string">docker </span><span class="hljs-string">login </span><span class="hljs-built_in">--username</span> <span class="hljs-string">AWS </span><span class="hljs-built_in">--password-stdin</span> <span class="hljs-string">470106750956.</span><span class="hljs-string">dkr.</span><span class="hljs-string">ecr.</span><span class="hljs-string">us-east-</span>1.<span class="hljs-string">amazonaws.</span><span class="hljs-string">com/</span><span class="hljs-string">api-monolitica </span>//<span class="hljs-string">login </span><span class="hljs-string">no </span><span class="hljs-string">ecr
</span>
<span class="hljs-string">docker </span><span class="hljs-string">build </span>-t <span class="hljs-string">api-monolitica </span>. //<span class="hljs-string">buildar </span>a <span class="hljs-string">sua </span><span class="hljs-string">imagem </span><span class="hljs-string">mas </span><span class="hljs-string">no </span><span class="hljs-string">exemplo </span><span class="hljs-string">abaixo </span><span class="hljs-string">usei </span><span class="hljs-string">uma </span><span class="hljs-string">imagem </span><span class="hljs-string">pronta
</span>
<span class="hljs-string">docker </span><span class="hljs-string">tag </span><span class="hljs-string">rmerces/</span><span class="hljs-string">api-monolitica:latest </span><span class="hljs-string">470106750956.</span><span class="hljs-string">dkr.</span><span class="hljs-string">ecr.</span><span class="hljs-string">us-east-</span>1.<span class="hljs-string">amazonaws.</span><span class="hljs-string">com/</span><span class="hljs-string">api-monolitica:latest </span>//<span class="hljs-string">usando </span><span class="hljs-string">uma </span><span class="hljs-string">imagem </span><span class="hljs-string">que </span>já <span class="hljs-string">havia </span><span class="hljs-string">feito </span><span class="hljs-string">pull </span><span class="hljs-string">anteriormente
</span>
<span class="hljs-string">docker </span><span class="hljs-string">push </span><span class="hljs-string">470106750956.</span><span class="hljs-string">dkr.</span><span class="hljs-string">ecr.</span><span class="hljs-string">us-east-</span>1.<span class="hljs-string">amazonaws.</span><span class="hljs-string">com/</span><span class="hljs-string">api-monolitica:latest </span>//<span class="hljs-string">push </span><span class="hljs-string">da </span><span class="hljs-string">imagem
</span></code></pre>
<p>Após no dash dos Repositories aparece a imagem com as suas tags, se houver:</p>
<p><img src="/blog-guilherme/blog/assets/ecrII.png" alt=""></p>
<p>Configurar regras para gerenciamento das imagens, clicar em Dry run of lifecycles rules e depois em Add</p>
<p><img src="/blog-guilherme/blog/assets/ecrIII.png" alt=""></p>
<p>Aparece a janela de configuração das regras onde Rule Priority é um número para definir as prioridades entre as outras regras criadas, Rule Description é um texto explicativo e Tag prefixes é pra saber em qual tag essa regra deve ser aplicada aqui no exemplo nas tags com prefixo dev</p>
<p><img src="/blog-guilherme/blog/assets/ecrVI.png" alt=""></p>
<p>Mais abaixo definimos como 2 no campo onde definimos Image count more than</p>
<p><img src="/blog-guilherme/blog/assets/ecrV.png" alt=""></p>
<p>Feito isso aplicamos a nossa regra</p>
<p><img src="/blog-guilherme/blog/assets/ecrVI.png" alt=""></p>
<p>E na nossa regra aparece as imagens que são gerenciadas pela regra</p>
<p><img src="/blog-guilherme/blog/assets/ecrVII.png" alt=""></p>
<p><strong>Criando Tasks</strong></p>
<p>As <em>tasks</em> configuram os parâmetros e o ambiente dos <em>containers</em>.</p>
<p>Gerenciamento de tasks com cli</p>
<pre><code class="hljs"><span class="hljs-string">aws </span><span class="hljs-string">ecs </span><span class="hljs-built_in">list-tasks</span> <span class="hljs-built_in">--cluster</span> <span class="hljs-string">ecs-api
</span>
<span class="hljs-string">aws </span><span class="hljs-string">ecs </span><span class="hljs-string">stop-task </span><span class="hljs-built_in">--taks</span> &lt;<span class="hljs-string">id-task&gt;</span> <span class="hljs-built_in">--cluster</span> &lt;<span class="hljs-string">nome-cluster&gt;</span> //<span class="hljs-string">stop </span><span class="hljs-string">task
</span>
<span class="hljs-string">aws </span><span class="hljs-string">ecs </span><span class="hljs-built_in">list-task-definitions</span> //<span class="hljs-string">lista </span><span class="hljs-string">tdoas </span><span class="hljs-string">as </span><span class="hljs-string">definiç</span>õ<span class="hljs-string">es </span><span class="hljs-string">independente </span><span class="hljs-string">do </span><span class="hljs-string">cluster
</span>
<span class="hljs-string">aws </span><span class="hljs-string">ecs </span><span class="hljs-string">run-task </span><span class="hljs-built_in">--cluster</span> <span class="hljs-string">ecs-api </span><span class="hljs-built_in">--task-definition</span> <span class="hljs-string">api-monolitica </span>//<span class="hljs-string">rodar </span><span class="hljs-string">uma </span><span class="hljs-string">task </span><span class="hljs-string">associando </span><span class="hljs-string">ao </span><span class="hljs-string">cluster
</span>
<span class="hljs-string">aws </span><span class="hljs-string">ecs </span><span class="hljs-string">run-task </span><span class="hljs-built_in">--cluster</span> &lt;<span class="hljs-string">nome-cluter&gt;</span> <span class="hljs-built_in">--task-definition</span> &lt;<span class="hljs-string">nome-task&gt;</span> <span class="hljs-built_in">--count</span> 3 //<span class="hljs-string">subir </span>vá<span class="hljs-string">rias </span><span class="hljs-string">instâ</span><span class="hljs-string">ncias
</span></code></pre>
<p>Criando Service</p>
<ul>
<li>Escolher como EC2</li>
<li>Definir a task</li>
<li>Definir o cluster</li>
<li>Definir o nome</li>
<li>Definir o numero de tasks</li>
</ul>
<p><img src="/blog-guilherme/blog/assets/service.png" alt=""></p>
<p>Escolher o load balance</p>
<p><img src="/blog-guilherme/blog/assets/serviceII.png" alt=""></p>
<p>Se não tiver um criar</p>
<p><strong>Criando Load Balance</strong></p>
<p>Selecionar HTTP/HTTPS</p>
<p><img src="/blog-guilherme/blog/assets/serviceIII.png" alt=""></p>
<p>Nomear load balance e configurar a VPC e subnets, no caso usei as padrões criadas no Fargate automaticamente</p>
<p><img src="/blog-guilherme/blog/assets/serviceIV.png" alt=""></p>
<p>Adicionar o security group também estou usando o criado automaticamente no Fargate</p>
<p><img src="/blog-guilherme/blog/assets/serviceV.png" alt=""></p>
<p>Configurar a rota, portas e etc, nesse caso só dei o nome e deixei mapeado na porta 80</p>
<p><img src="/blog-guilherme/blog/assets/serviceVI.png" alt=""></p>
<p>Após configurado o load balance é preciso configurar o target group</p>
<p><img src="/blog-guilherme/blog/assets/serviceVII.png" alt=""></p>
<p>Após toda a configuração ainda é necessário configurar o security group pois com essa configuração acima liberamos o load balance na porta 80 e agora precisamos liberar o acesso interno</p>
<p><img src="/blog-guilherme/blog/assets/serviceVIII.png" alt=""></p>
<p>Para saber e ver qual é a rede que deve ser liberada basta acessar o serviço de VPC e ver qual IP está associado</p>
<p><img src="/blog-guilherme/blog/assets/serviceIX.png" alt=""></p>
<p><strong>Subindo microservices</strong></p>
<ul>
<li>Subir três serviços, users, threads e posts usando as imagens em <a href="https://hub.docker.com/u/rmerces">DockerHUB</a></li>
<li>Criar três repositórios no ECR</li>
<li>Criar as tasks para cada repositório</li>
<li>Criar um novo load balance a unica diferença aqui é que quando estamos criando um load balance só conseguimos adicionar um target group e nesse caso teremos três, então criamos o load balance com um e depois no dash do load balance tem a opção target group e ali conseguimos adicionar os demais. E no load balance configuramos os ponteiros.</li>
<li>Após isso criar o Services</li>
</ul>
</span></div></article></div><div class="post"><header class="postHeader"><h1 class="postHeaderTitle"><a href="/blog-guilherme/blog/2020/04/20/post-kubernetes">Kubernetes</a></h1><p class="post-meta">April 20, 2020</p><div class="authorBlock"><p class="post-authorName"><a href="https://twitter.com/guilherme_ga86" target="_blank" rel="noreferrer noopener">Guilherme Alves</a></p><div class="authorPhoto"><a href="https://twitter.com/guilherme_ga86" target="_blank" rel="noreferrer noopener"><img src="https://graph.facebook.com/1426803577/picture/?height=200&amp;width=200" alt="Guilherme Alves"/></a></div></div></header><article class="post-content"><div><span><h1><a class="anchor" aria-hidden="true" id="kubernetes"></a><a href="#kubernetes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubernetes</h1>
<p><strong>Docker</strong></p>
<p>Uma das vantagens do <strong>Docker</strong> é a questão da portabilidade, os diferentes ambientes, desenvolvimento, homologação, produção podem ter sido configurados de diferentes maneiras o que pode fazer com que a aplicação funcione em um ambiente em não em outro. Através do <strong>Docker</strong>, é possível guardar em um container nossa aplicação com as dependências necessárias para que ela funcione, independentemente de estarmos no ambiente de desenvolvimento, homologação ou produção.</p>
<p><strong>Kubernetes</strong></p>
<p>O <strong>Kubernetes</strong> é uma plataforma open-source desenvolvida pela <strong>Google</strong>, lançada em 2015, com o objetivo de gerenciar containers que formam uma aplicação, automatizando assim processos de implementação, monitoramento e escalonamento.</p>
<p>O nome &quot;<strong>Kubernetes</strong>&quot; que vem da língua grega e significa <em>timoneiro</em> (o tripulante que navega o barco). Como o nome e a pronuncia é um pouco diferente, se popularizou a abreviação: <strong>K8s</strong></p>
<p><strong>Kubernetes</strong> é uma plataforma de gerenciamento de aplicações baseadas em containers, com o objetivo de que esses containers sigam um determinado estado de configuração.</p>
<ul>
<li>o <strong>Kubernetes</strong> é utilizado para criar um <em>cluster</em></li>
<li>um <em>cluster</em> é um ou mais container para disponibilizar que forma uma aplicação</li>
<li>dentro do <em>cluster</em> as maquinas se conhecem mas existe um &quot;gerente&quot;</li>
<li>o gerente se chama <em>master</em> (mestre em português)</li>
<li>no <em>cluster</em> também tem um ou mais <em>node</em> para rodar a aplicação</li>
<li>o Kubernetes tem o seu foco em aplicações que rodam usando containers</li>
<li>o Kubernetes é uma plataforma open-source desenvolvida pela <strong>Google</strong></li>
</ul>
<p>Os maiores provedores são;</p>
<ul>
<li>Amazon EKS</li>
<li>Azure Kubernetes Service</li>
<li>IBM Kubernetes Service</li>
<li>Red Hat OpenShift Container Platform</li>
</ul>
<p><strong>VirtualBox VM</strong></p>
<p>Para podermos usar o Kubernetes localmente devemos antes de mais nada ter um ambiente virtualizado para rodar o Minikube. Para isso precisamos instalar o VirtualBox.</p>
<p><strong>Kubectl</strong></p>
<p>Éa ferramenta de configuração da linha de comando do Kubernetes.</p>
<p><strong>Instalação</strong></p>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">Kubectl install and setup</a></p>
<p><strong>Minikube</strong></p>
<p>O <strong>Minikube</strong>é uma ferramenta que facilita executar o Kubernetes localmente, executando um cluster de <strong>Kubernetes</strong> com um único nó, o <strong>minikube</strong>nada mais é do que uma implementação de simples uso do <strong>Kubernetes</strong>.</p>
<p><strong>Instalação</strong></p>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-minikube/">Install minikube</a></p>
<p><strong>Comandos minikube</strong></p>
<pre><code class="hljs">minikube <span class="hljs-built_in">start</span><span class="hljs-comment"> // inicia o minikube</span>

minikube dashboard<span class="hljs-comment"> // acessar dashboard</span>

minikube status<span class="hljs-comment"> // status do minikube</span>

minikube <span class="hljs-built_in">stop</span><span class="hljs-comment"> // parar o cluster</span>

minikube ssh<span class="hljs-comment"> // acessar via ssh o cluster</span>

minikube <span class="hljs-built_in">delete</span><span class="hljs-comment"> // deletar o cluster</span>
</code></pre>
<p><strong>POD</strong></p>
<p>Os pods são os menores objetos que podem ser criados e gerenciados pelo Kubernetes, tais objetos são utilizados para abstrair os containers que formam uma aplicação.</p>
<p>Um pod possui um tamanho maior do que um container, podendo assim abstrair um ou mais containers.</p>
<p>Exemplo de arquivo para criar pod:</p>
<pre><code class="hljs"><span class="hljs-attribute">apiVersion</span>: v1
<span class="hljs-attribute">kind</span>: Pod
<span class="hljs-attribute">metadata</span>:
  <span class="hljs-attribute">name</span>: application
<span class="hljs-attribute">spec</span>:
  <span class="hljs-attribute">containers</span>:
    - <span class="hljs-attribute">name</span>: container-application
      <span class="hljs-attribute">image</span>: rafanercessian/<span class="hljs-attribute">aplicacao-loja</span>:v1
      <span class="hljs-attribute">ports</span>:
        - <span class="hljs-attribute">containerPort</span>: <span class="hljs-number">80</span>
</code></pre>
<p>Rodar POD</p>
<pre><code class="hljs">##pode ser qualquer nome o arquivo
kubectl create -f pod.yml
</code></pre>
<p><strong>DEPLOYMENT</strong></p>
<p>O objeto Pod seria o mais básico existente no Kubernetes e não adiciona uma camada do estado desejado de nossa aplicação para o Kubernetes gerenciar, dessa forma, quando trabalhamos com o Kubernetes, nós abstraimos o objeto Pod dentro de um objeto que oferece tais recursos, como por exemplo o objeto Deployment.</p>
<p>Exemplo de arquivo para criar deployment:</p>
<pre><code class="hljs"><span class="hljs-attribute">apiVersion</span>: apps/v1
<span class="hljs-attribute">kind</span>: Deployment
<span class="hljs-attribute">metadata</span>:
  <span class="hljs-attribute">name</span>: appication-deployment
<span class="hljs-attribute">spec</span>:
  <span class="hljs-attribute">selector</span>:
    <span class="hljs-attribute">matchLabels</span>:
      <span class="hljs-attribute">name</span>: application-pod
  <span class="hljs-attribute">template</span>:
    <span class="hljs-attribute">metadata</span>:
      <span class="hljs-attribute">labels</span>:
        <span class="hljs-attribute">name</span>: application-pod
    <span class="hljs-attribute">spec</span>:
      <span class="hljs-attribute">containers</span>:
        - <span class="hljs-attribute">name</span>: container-application
          <span class="hljs-attribute">image</span>: rafanercessian/<span class="hljs-attribute">aplicacao-loja</span>:v1
          <span class="hljs-attribute">ports</span>:
            - <span class="hljs-attribute">containerPort</span>: <span class="hljs-number">80</span>
</code></pre>
<p><strong>Rodar Deployment</strong></p>
<pre><code class="hljs">##O nome do arquivo pode ser qualquer um
kubectl create -f deployment.yml
</code></pre>
<p><strong>Escalar PODs</strong></p>
<p>No dashboard podemos adicionar a quantidade de PODs.</p>
<p>Se tentarmos acessar o um diretamente pelo seu IP não será possível pois como são objetos voláteis precisamos de outra forma de acessá-los.</p>
<p>Objeto Service é que fará o acesso aos PODs</p>
<p><strong>SERVICE</strong></p>
<p>Objeto que faz a comunicação entre os PODs, esse aqui fará o LoadBalance entre aplicações.</p>
<p>Exemplo:</p>
<pre><code class="hljs"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">service-application</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span>
  <span class="hljs-attr">ports:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">http</span>
      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">31822</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">application-pod</span>
</code></pre>
<p>Rodar Service:</p>
<pre><code class="hljs"><span class="hljs-selector-tag">kubectl</span> <span class="hljs-selector-tag">create</span> <span class="hljs-selector-tag">-f</span> <span class="hljs-selector-tag">service</span><span class="hljs-selector-class">.yml</span>
</code></pre>
<p>Pegar IP do Service:</p>
<pre><code class="hljs">minikube<span class="hljs-built_in"> service </span>service-application --url
</code></pre>
<p><strong>STAFULSET</strong></p>
<p>Objeto para guardar volumes.</p>
<p>Exemplo de um MySQL com um volume mapeado:</p>
<pre><code class="hljs"><span class="hljs-attribute">apiVersion</span>: apps/v1beta1
<span class="hljs-attribute">kind</span>: StatefulSet
<span class="hljs-attribute">metadata</span>:
  <span class="hljs-attribute">name</span>: statefulset-mysql
<span class="hljs-attribute">spec</span>:
  <span class="hljs-attribute">serviceName</span>: db
  <span class="hljs-attribute">template</span>:
    <span class="hljs-attribute">metadata</span>:
      <span class="hljs-attribute">labels</span>:
        <span class="hljs-attribute">name</span>: mysql
    <span class="hljs-attribute">spec</span>:
      <span class="hljs-attribute">containers</span>:
        - <span class="hljs-attribute">name</span>: container-mysql
          <span class="hljs-attribute">image</span>: <span class="hljs-attribute">mysql</span>:<span class="hljs-number">5.7</span>.<span class="hljs-number">19</span>
          <span class="hljs-attribute">ports</span>:
            - <span class="hljs-attribute">containerPort</span>: <span class="hljs-number">3306</span>
          <span class="hljs-attribute">env</span>:
            - <span class="hljs-attribute">name</span>: MYSQL_DATABASE
              <span class="hljs-attribute">value</span>: <span class="hljs-string">"loja"</span>
            - <span class="hljs-attribute">name</span>: MYSQL_USER
              <span class="hljs-attribute">value</span>: <span class="hljs-string">"root"</span>
            - <span class="hljs-attribute">name</span>: MYSQL_ALLOW_EMPTY_PASSWORD
              <span class="hljs-attribute">value</span>: <span class="hljs-string">"1"</span>
          <span class="hljs-attribute">volumeMounts</span>:
            - <span class="hljs-attribute">name</span>: volume-mysql
              <span class="hljs-attribute">mountPath</span>: /var/lib/mysql
      <span class="hljs-attribute">volumes</span>:
        - <span class="hljs-attribute">name</span>: volume-mysql
          <span class="hljs-attribute">persistentVolumeClaim</span>:
            <span class="hljs-attribute">claimName</span>: configuration-mysql
</code></pre>
<p><strong>PersistentVolumeClaim</strong></p>
<p>O objeto <strong>PersistentVolumeClaim</strong> irá conter as configurações de requisição de consumo de recursos de um volume persistente criado pelo administrador do cluster. O <strong>PersistentVolumeClaim</strong> apenas define as permissões e o tamanho do storage.</p>
<p>Objeto que contem as permissões de recursos dos <strong>PODs</strong></p>
<p>Exemplo:</p>
<pre><code class="hljs"><span class="hljs-symbol">apiVersion:</span> v1
<span class="hljs-symbol">kind:</span> PersistentVolumeClaim
<span class="hljs-symbol">metadata:</span>
<span class="hljs-symbol">  name:</span> configuration-mysql
<span class="hljs-symbol">spec:</span>
<span class="hljs-symbol">  accessModes:</span>
    - ReadWriteOnce
<span class="hljs-symbol">  resources:</span>
<span class="hljs-symbol">    requests:</span>
<span class="hljs-symbol">      storage:</span> <span class="hljs-number">3</span>Gi
</code></pre>
<p><strong>SERVICE DB</strong></p>
<p>Objeto que fará a comunicação entre os serviços web e o banco de dados.</p>
<p>Para o objeto <strong>StatefulSet</strong> funcionar, ele será um tanto diferente do que foi feito com o objeto Deployment, já que o primeiro exige a referência bidirecional. É preciso indicar a ele o serviço responsável pela abstração do objeto Pod.</p>
<p>Para isso, no arquivo do <strong>StatefulSet</strong>, logo abaixo de <strong>spec</strong>, acresentaremos <strong>serviceName</strong>, que será o nome do serviço colocado no arquivo do <strong>SERVICE DB</strong>, ou seja, db:</p>
<pre><code class="hljs"><span class="hljs-attribute">apiVersion</span>: apps/v1
<span class="hljs-attribute">kind</span>: StatefulSet
<span class="hljs-attribute">metadata</span>:
  <span class="hljs-attribute">name</span>: aplicacao-sistema-statefulset
<span class="hljs-attribute">spec</span>:
  <span class="hljs-attribute">serviceName</span>: aplicacao-sistema-statefulset
  <span class="hljs-attribute">selector</span>:
    <span class="hljs-attribute">matchLabels</span>:
      <span class="hljs-attribute">name</span>: aplicacao-sistema-pod-statefulset
  <span class="hljs-attribute">template</span>:
    <span class="hljs-attribute">metadata</span>:
      <span class="hljs-attribute">labels</span>:
        <span class="hljs-attribute">name</span>: aplicacao-sistema-pod-statefulset
    <span class="hljs-attribute">spec</span>:
      <span class="hljs-attribute">containers</span>:
        - <span class="hljs-attribute">name</span>: container-aplicacao-sistema-statefulset-v4
          <span class="hljs-attribute">image</span>: jnlucas/<span class="hljs-attribute">noticia-alura</span>:v4
          <span class="hljs-attribute">ports</span>:
            - <span class="hljs-attribute">containerPort</span>: <span class="hljs-number">80</span>
          <span class="hljs-attribute">lifecycle</span>:
            <span class="hljs-attribute">postStart</span>:
              <span class="hljs-attribute">exec</span>:
                <span class="hljs-attribute">command</span>: [<span class="hljs-string">"sh"</span>,<span class="hljs-string">"enviarMensagens.sh"</span>]

          <span class="hljs-attribute">volumeMounts</span>:
            - <span class="hljs-attribute">name</span>: imagens
              <span class="hljs-attribute">mountPath</span>: /var/www/html/uploads
            - <span class="hljs-attribute">name</span>: sessoes
              <span class="hljs-attribute">mountPath</span>: /tmp
      <span class="hljs-attribute">volumes</span>:
        - <span class="hljs-attribute">name</span>: imagens
          <span class="hljs-attribute">persistentVolumeClaim</span>:
            <span class="hljs-attribute">claimName</span>: permissao-imagens
        - <span class="hljs-attribute">name</span>: sessoes
          <span class="hljs-attribute">persistentVolumeClaim</span>:
            <span class="hljs-attribute">claimName</span>: permissao-sessao
</code></pre>
<p>Exemplo do arquivo .sh</p>
<pre><code class="hljs"><span class="hljs-meta">#!/bin/bash
</span>
curl -X POST

-H <span class="hljs-string">'Content-type: alication/json'</span>

--data <span class="hljs-string">'{

"text": "Olá, um novo pod acabou de ser criado!"

}'</span>

https://hooks.slack.com/services/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
</code></pre>
<p><strong>Automatizando Autoscaler</strong></p>
<p>Primeiramente devemos configurar o arquivo que contém o <strong>Deployment</strong> para que ele contenha métricas, no caso de exemplo uma métrica de CPU para cada POD:</p>
<pre><code class="hljs"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">application-deployment</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">application-pod</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">application-pod</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">container-application-cpu</span>
          <span class="hljs-attr">image:</span> <span class="hljs-string">jnlucas/noticia-alura:v3</span>
          <span class="hljs-attr">ports:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span>
          <span class="hljs-comment">#Aqui é feita a definição de métricas</span>
          <span class="hljs-attr">resources:</span>
            <span class="hljs-attr">requests:</span>
              <span class="hljs-attr">cpu:</span> <span class="hljs-string">200m</span>
</code></pre>
<p>Agora é necessário adicionar essa métrica ao ambiente do Kubernetes</p>
<pre><code class="hljs">kubectl autoscale deployment application-deployment <span class="hljs-attribute">--cpu-percent</span>=50 <span class="hljs-attribute">--min</span>=1 <span class="hljs-attribute">--max</span>=10
</code></pre>
<p>Aqui definimos o autoscale para o application-deployment que se a porcentagem da CPU passar 50% iremos inicializar um novo POD com um limite de até 10. E com isso também definimos que se a porcentagem abaixar ele também irá matar esses PODs com o mínimo de 1 POD.</p>
<p><strong>Parametrização de CPU e memória de cada Pod</strong></p>
<ul>
<li>a configuração para tal é feita no container através de um elemento <em>resources</em> onde podemos especificar <em>requests</em> e <em>limits</em></li>
<li><em>requests</em> é o valor o container está garantido de ter</li>
<li><em>limits</em> é o máximo permitido o que o container terá disponível</li>
</ul>
<pre><code class="hljs"><span class="hljs-symbol">resources:</span>
<span class="hljs-symbol">requests:</span>
<span class="hljs-symbol">  memory:</span> <span class="hljs-string">"16Mi"</span>
<span class="hljs-symbol">  cpu:</span> <span class="hljs-string">"100m"</span>
<span class="hljs-symbol">limits:</span>
<span class="hljs-symbol">  memory:</span> <span class="hljs-string">"32Mi"</span>
<span class="hljs-symbol">  cpu:</span> <span class="hljs-string">"200m"</span>
</code></pre>
<p><strong>Comandos</strong></p>
<pre><code class="hljs"><span class="hljs-comment">#para listar os addons</span>

minikube addons list

<span class="hljs-comment">#para habilitar</span>

minikube addons <span class="hljs-builtin-name">enable</span> metrics-server

<span class="hljs-comment">#Para desabilitar</span>

minikube addons <span class="hljs-builtin-name">disable</span> metrics-server

<span class="hljs-comment">##detalhes sobre todos os pods</span>

kubectl describe pods | grep<span class="hljs-built_in"> IP
</span>
<span class="hljs-comment">##detalhes de um pod especifico</span>

kubectl describe pod &lt;nome-do-pod&gt;

<span class="hljs-comment">## mais informações</span>

kubectl <span class="hljs-builtin-name">get</span> pods -o wide

kubectl <span class="hljs-builtin-name">get</span> nodes

kubectl explain pod

kubectl explain node

kubectl <span class="hljs-builtin-name">get</span> pod &lt;nome-do-pod&gt;

kubectl <span class="hljs-builtin-name">get</span> deployment &lt;nome-do-deployment&gt;

kubectl <span class="hljs-builtin-name">get</span><span class="hljs-built_in"> service </span>&lt;nome-do-service&gt;

kubectl scale deployment application-deployment <span class="hljs-attribute">--replicas</span>=3

kubectl create -f service-application.yaml

kubectl <span class="hljs-builtin-name">get</span> pods

kubectl logs &lt;nome-pod-name&gt;

kubectl exec -it [nome <span class="hljs-keyword">do</span> Pod com o banco] sh

kubectl <span class="hljs-builtin-name">get</span><span class="hljs-built_in"> service
</span>
kubectl create -f statefulset.yaml

kubectl create -f service-database.yaml

kubectl create -f permitions.yaml

kubectl create -f deployment.yaml

kubectl create -f service-application.yaml

<span class="hljs-comment">##Editando um Deployment via VIM e command line</span>

kubectl <span class="hljs-builtin-name">edit</span> deployment aplicacao-noticia-deployment

<span class="hljs-comment">##para listar os pods</span>

kubectl <span class="hljs-builtin-name">get</span> pods

<span class="hljs-comment">##tbm funcionar para deployments e services, por exemplo:</span>

kubectl <span class="hljs-builtin-name">get</span> services

<span class="hljs-comment">##para detalhes de um pod</span>

kubectl describe pod &lt;nome-pod&gt;

<span class="hljs-comment">##o comando describe tbm funciona para deployment e service, por exemplo:</span>

kubectl describe<span class="hljs-built_in"> service </span>&lt;nome&gt;

<span class="hljs-comment">##para criar pod, deployment ou service a partir de um arquivo yml</span>

kubectl create -f &lt;nome-arquivo-yml&gt;

<span class="hljs-comment">##para remover pod, deployment ou service a partir de um arquivo yml</span>

kubectl delete -f &lt;nome-arquivo-yml&gt;

<span class="hljs-comment">##para remover um pod</span>

kubectl delete pod &lt;nome-pod&gt;

<span class="hljs-comment">##para remover um deployment</span>

kubectl delete deployment &lt;nome-deployment&gt;

<span class="hljs-comment">##para remover um service</span>

kubectl delete<span class="hljs-built_in"> service </span>&lt;nome-service&gt;
</code></pre>
</span></div></article></div><div class="post"><header class="postHeader"><h1 class="postHeaderTitle"><a href="/blog-guilherme/blog/2020/04/10/post-docker">Docker</a></h1><p class="post-meta">April 10, 2020</p><div class="authorBlock"><p class="post-authorName"><a href="https://twitter.com/guilherme_ga86" target="_blank" rel="noreferrer noopener">Guilherme Alves</a></p><div class="authorPhoto"><a href="https://twitter.com/guilherme_ga86" target="_blank" rel="noreferrer noopener"><img src="https://graph.facebook.com/1426803577/picture/?height=200&amp;width=200" alt="Guilherme Alves"/></a></div></div></header><article class="post-content"><div><span><h1><a class="anchor" aria-hidden="true" id="docker"></a><a href="#docker" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker</h1>
<p><strong>O que é?</strong></p>
<p>Tecnologia utilizada para baratear o custo de hospedar várias aplicações em uma mesma máquina.</p>
<p><strong>Diferença entre entre Dokcer e VM.</strong></p>
<p>Virtualização é a tecnologia que virtualiza os drivers do pc o que se torna várias máquinas rodando em uma unica máquina.</p>
<p>Melhor aproveitamento dos recursos do servidor.</p>
<p>Problemas da virtualização, cada aplicação com um sistema operacional por VM e isso é custoso tanto na configuração quanto no consumo de hardwares.</p>
<p>Containers são lugares onde a aplicação ira ser executada e eles rodarão sobre o sistema operacional do servidor. É mais leve pois só tem o SO do servidor e eles compartilham os recursos do SO.</p>
<p>Um <strong><em>container</em></strong> funcionará junto do nosso sistema operacional base, e conterá a nossa aplicação, ou seja, a aplicação será executada dentro dele. Criamos um <em>container</em> para cada aplicação, e esses <em>containers</em> vão <strong>dividir</strong> as funcionalidades do sistema operacional.</p>
<p>Com os <em>containers</em>, conseguimos limitar o consumo de CPU das aplicações, melhorando o controle sobre o uso de cada recurso do nosso sistema (CPU, rede, etc). Também temos uma facilidade maior em trabalhar com versões específicas de linguagens/bibliotecas, além de ter uma agilidade maior na hora de criar e subir <em>containers</em>, já que eles são mais leves que as máquinas virtuais.</p>
<p><strong>Instalação</strong></p>
<p><a href="https://www.digitalocean.com/community/tutorials/como-instalar-e-usar-o-docker-no-ubuntu-18-04-pt">Linux</a></p>
<p><strong>Layered File System</strong></p>
<p>Imagens com várias camadas. Camadas podem ser compartilhadas e são somente read only. Podem ser aproveitadas por vários containers</p>
<p><strong>Volumes</strong></p>
<p>O volume fica no <em>Docker Host</em>. Ou seja, fica salvo no computador onde a <em>Docker Engine</em> está rodando.</p>
<p>Persistir dados com containers, pois os containers são voláteis.</p>
<p>Exemplo:</p>
<pre><code class="hljs">docker <span class="hljs-keyword">run</span><span class="bash"> -v <span class="hljs-string">"C:\Users\develop:/var/www"</span> ubuntu</span>
</code></pre>
<p>O parâmetro <em>-v</em> (volume) primeira parte é o caminho na sua máquina e o segundo é o caminho no container</p>
<p>Mesmo após o container ser removido os dados desse path não serão destruídos juntos.</p>
<p>Exemplo executando um código salvo em uma pasta em um container:</p>
<pre><code class="hljs">docker run -p <span class="hljs-number">8080</span>:<span class="hljs-number">3000</span> -v <span class="hljs-string">"C:\Users\develop\repo\volume-exemplo:/var/www"</span> -w <span class="hljs-string">"/var/www"</span> <span class="hljs-keyword">node</span> <span class="hljs-title">npm</span> <span class="hljs-literal">start</span>
</code></pre>
<p><em>-w</em> working directory aponta onde, qual pasta ou path, o container deve iniciar</p>
<p><strong>Criando imagens personalizadas usando Dockerfile</strong></p>
<p><strong>FROM</strong> comando pra aproveitar imagem base</p>
<p><strong>MAINTAINER</strong> pessoa responsavel</p>
<p><strong>ENV</strong> variaveis de ambiente</p>
<p><strong>COPY</strong> copia pra dentro da imagem</p>
<p><strong>WORKDIR</strong> assim que o container carregar no caminho especificado</p>
<p><strong>RUN</strong> comando que roda enquanto está construindo a imagem</p>
<p><strong>ENTRYPOINT</strong> comando que será executado assim que terminar de construir o container</p>
<p><strong>EXPOSE</strong> porta que será aberta</p>
<p>Exemplo:</p>
<pre><code class="hljs"><span class="hljs-keyword">FROM</span> node:latest

MAINTANER Guilherme Alves

<span class="hljs-keyword">ENV</span> PORT=<span class="hljs-number">3000</span>

<span class="hljs-keyword">COPY</span><span class="bash"> . /var/www</span>

<span class="hljs-keyword">WORKDIR</span><span class="bash"> /var/www</span>

<span class="hljs-keyword">RUN</span><span class="bash"> npm install</span>

<span class="hljs-keyword">ENTRYPOINT</span><span class="bash"> npm start</span>

<span class="hljs-keyword">EXPOSE</span> $PORT
</code></pre>
<pre><code class="hljs">docker build -f <span class="hljs-tag">&lt;<span class="hljs-name">nome</span> <span class="hljs-attr">do</span> <span class="hljs-attr">arquivo</span>&gt;</span> -t <span class="hljs-tag">&lt;<span class="hljs-name">tag</span>&gt;</span> . <span class="hljs-tag">&lt;<span class="hljs-name">contexto</span>&gt;</span>

docker run -d -p 8080:3000 <span class="hljs-tag">&lt;<span class="hljs-name">tag</span>&gt;</span>
</code></pre>
<p><strong>Subir para dockerhub</strong></p>
<p>docker login</p>
<p>docker push <tag></p>
<p><strong>Network</strong></p>
<p>Comunicando vários containers.</p>
<p>Na rede default eles se comunicam apenas por IP</p>
<p>Comando para criar sua própria rede:</p>
<pre><code class="hljs">docker<span class="hljs-built_in"> network </span>create --driver<span class="hljs-built_in"> bridge </span>&lt;nome-da-rede&gt;
</code></pre>
<p>Existem outros drivers mas o mais comum é o <strong><em>bridge</em></strong></p>
<p>Atrelar o contêiner na rede criada:</p>
<pre><code class="hljs">docker run --name <span class="hljs-tag">&lt;<span class="hljs-name">nome-do-container</span>&gt;</span> --netowrk <span class="hljs-tag">&lt;<span class="hljs-name">nome-da-rede</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">imagem</span>&gt;</span>
</code></pre>
<p>Com isso conseguimos nos comunicar entre os contêiner pelo nome.</p>
<p><strong>Docker Compose</strong></p>
<p>Ferramenta para facilitar, automatizar e prever falhas para comunicação entre containers.</p>
<p>Todo o processo é escrito em um arquivo chamado <strong>docker-compose.yml</strong></p>
<p><strong>Instalação</strong></p>
<p><a href="https://docs.docker.com/compose/install/">Docker Compose Install Documentation</a></p>
<p>Exemplo de uma aplicação com um banco de dados <strong>MySQL</strong>, uma aplicação <strong>NodeJS</strong> e um Load Balance com <strong>NGINX</strong></p>
<pre><code class="hljs"><span class="hljs-symbol">version:</span> <span class="hljs-string">'3'</span> <span class="hljs-comment">//versão do docker compose</span>
<span class="hljs-symbol">services:</span> <span class="hljs-comment">//nome dos serviços que vão ser rodados</span>
<span class="hljs-symbol">  nginx:</span> <span class="hljs-comment">// aqui é feita a condfiguração do NGINX que é um container que possui um Dokcerfile</span>
<span class="hljs-symbol">    build:</span>
<span class="hljs-symbol">      dockerfile:</span> .<span class="hljs-meta-keyword">/docker/</span>nginx.dockerfile <span class="hljs-comment">//dizemos onde está o arquivos Dockerfile que deve ser buildado</span>
<span class="hljs-symbol">      context:</span> . <span class="hljs-comment">//a partir de onde ele tem que buscar</span>
<span class="hljs-symbol">    image:</span> <span class="hljs-params">&lt;nome-da-imagem&gt;</span> <span class="hljs-comment">//nome da imagem</span>
<span class="hljs-symbol">    container_name:</span> nginx <span class="hljs-comment">//nome pro container</span>
<span class="hljs-symbol">    ports:</span> <span class="hljs-comment">//mapear as portas que serão expostas</span>
      - <span class="hljs-string">"80:80"</span> <span class="hljs-comment">//porta de fora:porta de dentro</span>
<span class="hljs-symbol">    networks:</span>
      - production-network <span class="hljs-comment">//nome da network criada abaixo</span>
<span class="hljs-symbol">    depends_on:</span>
      - <span class="hljs-string">"node"</span> <span class="hljs-comment">//o nginx só sobe depois que o node subir</span>
<span class="hljs-symbol">  mongodb:</span>
<span class="hljs-symbol">    image:</span> mongo <span class="hljs-comment">//imagem padrão</span>
<span class="hljs-symbol">    networks:</span>
      - production-network
<span class="hljs-symbol">  node:</span>
<span class="hljs-symbol">    build:</span>
<span class="hljs-symbol">      dockerfile:</span> <span class="hljs-comment">//path de onde está o Dockerfile</span>
<span class="hljs-symbol">      context:</span> . <span class="hljs-comment">//a partir de onde procurar o Dockerfile</span>
<span class="hljs-symbol">    image:</span> <span class="hljs-comment">//nome da imagem</span>
<span class="hljs-symbol">    container_name:</span> <span class="hljs-comment">//nome dado ao container</span>
<span class="hljs-symbol">    ports:</span>
      - <span class="hljs-string">"3000"</span>
<span class="hljs-symbol">    networks:</span>
      - production-network
<span class="hljs-symbol">    depends_on:</span>
      - <span class="hljs-string">"mongo"</span> <span class="hljs-comment">//indica que o node só vai subir depois que o mongo subir</span>
<span class="hljs-symbol">networks:</span> <span class="hljs-comment">//criando a rede pra comunicação dos containers</span>
  production-network: <span class="hljs-comment">//nome que você quiser</span>
<span class="hljs-symbol">    driver:</span> bridge

</code></pre>
<p>Executando:</p>
<pre><code class="hljs">docker-compose build <span class="hljs-comment">//buildar imagens</span>

docker-compose up -d <span class="hljs-comment">//subir containers a partir do compose</span>

docker-compose ps <span class="hljs-comment">//lista todos</span>

docker-compose down <span class="hljs-comment">//terminar todos os containers</span>

docker-compose restart <span class="hljs-comment">//restarta os containers</span>
</code></pre>
<p><strong>Instalando Docker Compose</strong></p>
<p>sudo curl -L <a href="https://github.com/docker/compose/releases/download/1.15.0/docker-compose-">https://github.com/docker/compose/releases/download/1.15.0/docker-compose-</a><code>uname -s</code>-<code>uname -m</code> -o /usr/local/bin/docker-compose</p>
<pre><code class="hljs">sudo chmod +x <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>docker-compose
</code></pre>
<p><strong>Comandos Básicos</strong></p>
<ul>
<li><p>Comandos relacionados às informações</p></li>
<li><p>docker version <strong>-</strong> exibe a versão do docker que está instalada.</p></li>
<li><p>docker inspect ID_CONTAINER <strong>-</strong> retorna diversas informações sobre o container.</p></li>
<li><p>docker ps <strong>-</strong> exibe todos os containers em execução no momento.</p></li>
<li><p>docker ps -a <strong>-</strong> exibe todos os containers, independentemente de estarem em execução ou não.</p></li>
<li><p>Comandos relacionados à execução</p></li>
<li><p>docker run NOME_DA_IMAGEM <strong>-</strong> cria um container com a respectiva imagem passada como parâmetro.</p></li>
<li><p>docker run -it NOME_DA_IMAGEM <strong>-</strong> conecta o terminal que estamos utilizando com o do container.</p></li>
<li><p>docker run -d -P --name NOME dockersamples/static-site <strong>-</strong> ao executar, dá um nome ao container.</p></li>
<li><p>docker run -d -p 12345:80 dockersamples/static-site <strong>-</strong> define uma porta específica para ser atribuída à porta 80 do container, neste caso 12345.</p></li>
<li><p>docker run -v &quot;CAMINHO_VOLUME&quot; NOME_DA_IMAGEM <strong>-</strong> cria um volume no respectivo caminho do container.</p></li>
<li><p>docker run -it --name NOME_CONTAINER --network NOME_DA_REDE NOME_IMAGEM <strong>-</strong> cria um container especificando seu nome e qual rede deverá ser usada.</p></li>
<li><p>Comandos relacionados à inicialização/interrupção</p></li>
<li><p>docker start ID_CONTAINER <strong>-</strong> inicia o container com id em questão.</p></li>
<li><p>docker start -a -i ID_CONTAINER <strong>-</strong> inicia o container com id em questão e integra os terminais, além de permitir interação entre ambos.</p></li>
<li><p>docker stop ID_CONTAINER <strong>-</strong> interrompe o container com id em questão.</p></li>
<li><p>Comandos relacionados à remoção</p></li>
<li><p>docker rm ID_CONTAINER <strong>-</strong> remove o container com id em questão.</p></li>
<li><p>docker container prune <strong>-</strong> remove todos os containers que estão parados.</p></li>
<li><p>docker rmi NOME_DA_IMAGEM <strong>-</strong> remove a imagem passada como parâmetro.</p></li>
<li><p>Comandos relacionados à construção de Dockerfile</p></li>
<li><p>docker build -f Dockerfile <strong>-</strong> cria uma imagem a partir de um Dockerfile.</p></li>
<li><p>docker build -f Dockerfile -t NOME_USUARIO/NOME_IMAGEM <strong>-</strong> constrói e nomeia uma imagem não-oficial.</p></li>
<li><p>docker build -f Dockerfile -t NOME_USUARIO/NOME_IMAGEM CAMINHO_DOCKERFILE <strong>-</strong> constrói e nomeia uma imagem não-oficial informando o caminho para o Dockerfile.</p></li>
<li><p>Comandos relacionados ao Docker Hub</p></li>
<li><p>docker login <strong>-</strong> inicia o processo de login no Docker Hub.</p></li>
<li><p>docker push NOME_USUARIO/NOME_IMAGEM <strong>-</strong> envia a imagem criada para o Docker Hub.</p></li>
<li><p>docker pull NOME_USUARIO/NOME_IMAGEM <strong>-</strong> baixa a imagem desejada do Docker Hub.</p></li>
<li><p>Comandos relacionados à rede</p></li>
<li><p>hostname -i <strong>-</strong> mostra o ip atribuído ao container pelo docker (funciona apenas dentro do container).</p></li>
<li><p>docker network create --driver bridge NOME_DA_REDE <strong>-</strong> cria uma rede especificando o driver desejado.</p></li>
<li><p>Comandos relacionados ao docker-compose</p></li>
<li><p>docker-compose build <strong>-</strong> Realiza o build dos serviços relacionados ao arquivo docker-compose.yml, assim como verifica a sua sintaxe.</p></li>
<li><p>docker-compose up <strong>-</strong> Sobe todos os containers relacionados ao docker-compose, desde que o build já tenha sido executado.</p></li>
<li><p>docker-compose down <strong>-</strong> Para todos os serviços em execução que estejam relacionados ao arquivo docker-compose.yml.</p></li>
</ul>
</span></div></article></div><div class="docs-prevnext"></div></div></div></div></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/blog-guilherme/" class="nav-home"><img src="/blog-guilherme/img/dog.png" alt="Tutoriais" width="66" height="58"/></a><div><h5>Community</h5><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://twitter.com/guilherme_ga86" target="_blank" rel="noreferrer noopener">Twitter</a></div><div><h5>More</h5><a href="/blog-guilherme/blog">Blog</a><a href="https://github.com/">GitHub</a><a class="github-button" data-icon="octicon-star" data-count-href="/facebook/docusaurus/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a><div class="social"><div class="fb-like" data-href="https://guilhermegarcia86.github.io" data-colorscheme="dark" data-layout="standard" data-share="true" data-width="225" data-show-faces="false"></div></div></div></section><section class="copyright">Copyright © 2020</section></footer></div><script>window.fbAsyncInit = function() {FB.init({appId:'524104774884756',xfbml:true,version:'v2.7'});};(function(d, s, id){var js, fjs = d.getElementsByTagName(s)[0];if (d.getElementById(id)) {return;}js = d.createElement(s); js.id = id;js.src = '//connect.facebook.net/en_US/sdk.js';fjs.parentNode.insertBefore(js, fjs);}(document, 'script','facebook-jssdk'));
                </script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script></body></html>